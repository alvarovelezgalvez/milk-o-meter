<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>milk-o-meter üçº</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{
      --baby-pink:#ffd6e7;
      --baby-blue:#dff3ff;
      --baby-mint:#e9fff5;
      --baby-purple:#efe7ff;
      --ink:#4a5568;
    }
    body{background:linear-gradient(180deg,var(--baby-blue),var(--baby-mint)); color:var(--ink); min-height:100vh}
    .card{border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); border:none}
    .btn-primary{background:#ff8fb3;border-color:#ff8fb3}
    .btn-primary:hover{background:#ff7aa5;border-color:#ff7aa5}
    .btn-success{background:#6bd1b3;border-color:#6bd1b3}
    .chip{background:var(--baby-purple); border-radius:999px; padding:.25rem .6rem; display:inline-block; font-size:0.85em}
    .stars span{cursor:pointer; user-select:none; font-size:1.8rem}
    .list-group-item{border-radius:1rem; margin-bottom:.5rem; border:none; background:rgba(255,255,255,0.9)}
    .star-filled{color:#ffc107}
    .star-empty{color:#ddd}
    .badge-estrella{background:#ffc107; color:#000}
    .toma-izquierda{border-left:4px solid #ff8fb3}
    .toma-derecha{border-left:4px solid #6bd1b3}
    .toma-ambos{border-left:4px solid #9d7aff}
    .connection-badge{font-size:0.75em}
    .stars{color:#ffc107; font-size:1.2rem}
    .historial-item{display:flex; flex-direction:column; gap:0.5rem}
    .historial-item-header{display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; flex-wrap:wrap}
    .historial-item-content{flex:1; min-width:0}
    .historial-item-actions{display:flex; gap:0.5rem; flex-shrink:0}
    @media (max-width:576px){
      .historial-item-header{flex-direction:column; gap:0.75rem}
      .historial-item-actions{width:100%; justify-content:flex-end}
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="container py-4" id="loginView">
  <div class="card p-4 mx-auto" style="max-width:400px">
    <div class="text-center mb-3">
      <h1 class="display-1">üçº</h1>
      <h3 class="mb-2">milk-o-meter</h3>
      <p class="text-muted">Seguimiento de lactancia üíï</p>
    </div>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a" autocomplete="off" />
    <button class="btn btn-primary w-100" onclick="login()">
      <i class="bi bi-door-open"></i> Entrar
    </button>
  </div>
</div>

<!-- APP -->
<div class="container py-3 d-none" id="appView">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">milk-o-meter üçº</h3>
      <div class="connection-badge">
        <span class="badge" id="syncStatus">‚óè Desconectado</span>
        <small class="text-muted ms-2" id="lastSync">--:--</small>
      </div>
    </div>
    <div>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Resumen -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-graph-up"></i> Resumen de hoy
      </h6>
      <div class="row text-center">
        <div class="col">
          <div class="display-6" id="totalTomas">0</div>
          <small class="text-muted">Tomas</small>
        </div>
        <div class="col">
          <div class="display-6" id="tiempoTotal">0h 0m</div>
          <small class="text-muted">Tiempo</small>
        </div>
        <div class="col">
          <div class="display-6" id="ultimaToma">--:--</div>
          <small class="text-muted">√öltima</small>
        </div>
      </div>
      <div class="mt-2 text-center">
        <small class="text-muted" id="totalRegistros">Cargando...</small>
      </div>
    </div>
  </div>

  <!-- Estad√≠sticas Detalladas -->
  <div class="accordion mb-3" id="accordionEstadisticas">
    <div class="accordion-item card" style="border: none;">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEstadisticas" aria-expanded="false" aria-controls="collapseEstadisticas">
          <i class="bi bi-bar-chart me-2"></i> Estad√≠sticas Detalladas
        </button>
      </h2>
      <div id="collapseEstadisticas" class="accordion-collapse collapse" data-bs-parent="#accordionEstadisticas">
        <div class="accordion-body">
          <div id="estadisticasDetalladas">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-muted">Calculando estad√≠sticas...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√≥n Nueva toma -->
  <button class="btn btn-success w-100 mb-3 py-3" onclick="nuevaToma()">
    <i class="bi bi-plus-circle"></i> Nueva toma
  </button>

  <!-- Formulario Toma -->
  <div id="formToma" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title mb-3" id="formTitle">
        <i class="bi bi-clock-history"></i> Nueva toma
      </h5>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-play-circle"></i> Hora inicio</label>
        <input type="time" id="inicio" class="form-control form-control-lg" required />
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-stop-circle"></i> Hora fin</label>
        <div class="input-group">
          <input type="time" id="fin" class="form-control" />
          <button class="btn btn-outline-secondary" type="button" onclick="cerrarAhora()">
            <i class="bi bi-clock"></i> Ahora
          </button>
        </div>
        <small class="text-muted">Dejar vac√≠o si a√∫n est√° tomando</small>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-star"></i> Calidad de la toma</label>
        <div id="estrellas" class="stars text-center">
          <span onclick="setStars(1)">‚òÜ</span>
          <span onclick="setStars(2)">‚òÜ</span>
          <span onclick="setStars(3)">‚òÜ</span>
          <span onclick="setStars(4)">‚òÜ</span>
          <span onclick="setStars(5)">‚òÜ</span>
        </div>
        <div class="text-center mt-1">
          <span id="estrellasTexto" class="badge badge-estrella">0 estrellas</span>
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-symmetry-vertical"></i> Teta</label>
        <select id="lado" class="form-select">
          <option value="Izquierda">üëà Izquierda</option>
          <option value="Derecha">üëâ Derecha</option>
          <option value="Ambas">ü§≤ Ambas</option>
        </select>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-chat-text"></i> Comentarios</label>
        <textarea id="comentarios" class="form-control" rows="2" placeholder="Notas, observaciones..."></textarea>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="guardarToma()" id="btnGuardar">
          <i class="bi bi-save"></i> Guardar Toma
        </button>
        <button class="btn btn-outline-danger" onclick="cancelarToma()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-list-check"></i> Historial de tomas
      </h6>
      <div id="lista" class="list-group list-group-flush">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Cargando tomas...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/************ CONFIGURACI√ìN ************/
const APP_PASSWORD = 'ari';
const CONFIG_KEY = 'milkometer_config_v1';
const DATA_KEY = 'milkometer_local_data_v1';

let tomas = [];
let editId = null;
let estrellasValor = 3;
let config = null;
let syncInterval = null;

/************ INICIALIZACI√ìN ************/
document.addEventListener('DOMContentLoaded', function() {
  const passwordField = document.getElementById('password');
  if (passwordField) {
    passwordField.focus();
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
  
  if (localStorage.getItem('milkometer_auth') === 'true') {
    initApp();
  }
});

/************ AUTENTICACI√ìN ************/
function login() {
  const password = document.getElementById('password').value;
  if (password === APP_PASSWORD) {
    localStorage.setItem('milkometer_auth', 'true');
    initApp();
  } else {
    alert('Contrase√±a incorrecta');
    document.getElementById('password').focus();
    document.getElementById('password').select();
  }
}

function logout() {
  if (confirm('¬øSeguro que quieres salir?')) {
    localStorage.removeItem('milkometer_auth');
    if (syncInterval) clearInterval(syncInterval);
    location.reload();
  }
}

/************ INICIALIZACI√ìN APP ************/
async function initApp() {
  document.getElementById('loginView').classList.add('d-none');
  document.getElementById('appView').classList.remove('d-none');
  cargarConfig();
  // Cargar datos locales primero para mostrar algo inmediatamente
  cargarDatos();
  // Si hay configuraci√≥n, sincronizar inmediatamente con GitHub
  if (config && config.githubUser && config.githubToken) {
    await sincronizarConGitHub();
  }
  syncInterval = setInterval(sincronizarConGitHub, 30000);
}

/************ CONFIG GITHUB ************/
function cargarConfig() {
  // Si la contrase√±a es "ari", cargar configuraci√≥n autom√°tica
  const configGuardada = localStorage.getItem(CONFIG_KEY);
  if (configGuardada) {
    try {
      config = JSON.parse(configGuardada);
    } catch (e) {
      console.error('Error cargando configuraci√≥n:', e);
      config = null;
    }
  }
  
  // Si no hay configuraci√≥n guardada y la contrase√±a es "ari", usar configuraci√≥n por defecto
  if ((!config || !config.githubUser || !config.githubToken) && APP_PASSWORD === 'ari') {
    config = {
      githubUser: 'alvarovelezgalvez',
      repoName: 'milk-o-meter',
      githubToken: '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',
      configuredAt: new Date().toISOString(),
      autoConfigured: true
    };
    localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  } else if (!config || !config.githubUser || !config.githubToken) {
    // Solo mostrar modal si la contrase√±a NO es "ari"
    if (APP_PASSWORD !== 'ari') {
      setTimeout(mostrarConfig, 500);
    }
  }
}


/************ GESTI√ìN DE DATOS ************/
function cargarDatos() {
  const datosLocales = localStorage.getItem(DATA_KEY);
  if (datosLocales) {
    try { tomas = JSON.parse(datosLocales); } catch(e){ tomas=[]; }
  }
  renderizarTomas(); actualizarResumen(); actualizarInfo(); actualizarEstadisticasDetalladas();
}

function guardarDatosLocales() {
  localStorage.setItem(DATA_KEY, JSON.stringify(tomas));
}

async function guardarDatos() {
  guardarDatosLocales();
  if (config && config.githubUser && config.githubToken) {
    try { await guardarDatosEnGitHub(); actualizarSyncStatus('success', 'Guardado en GitHub'); }
    catch(e){ actualizarSyncStatus('warning','Guardado localmente'); }
  } else actualizarSyncStatus('warning','Guardado localmente');
}

/************ INTERFAZ ************/
function actualizarSyncStatus(status,texto){
  const statusElement = document.getElementById('syncStatus');
  const badgeClass = {'success':'bg-success','warning':'bg-warning','danger':'bg-danger'}[status] || 'bg-secondary';
  statusElement.className = `badge ${badgeClass}`; statusElement.textContent = `‚óè ${texto}`;
  const ahora = new Date();
  document.getElementById('lastSync').textContent = `${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;
}

function actualizarInfo(){
  const hoy = new Date().toISOString().split('T')[0];
  const tomasHoy = tomas.filter(t => t.fecha === hoy).length;
  const totalTomas = tomas.length;
  document.getElementById('totalRegistros').textContent = `${tomasHoy} tomas hoy | ${totalTomas} en total`;
}

function nuevaToma() {
  editId=null;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-clock-history"></i> Nueva toma';
  const ahora=new Date();
  const hora=String(ahora.getHours()).padStart(2,'0');
  const minutos=String(ahora.getMinutes()).padStart(2,'0');
  document.getElementById('inicio').value=`${hora}:${minutos}`;
  document.getElementById('fin').value=''; document.getElementById('comentarios').value='';
  setStars(3); document.getElementById('lado').value='Izquierda';
  document.getElementById('btnGuardar').innerHTML='<i class="bi bi-save"></i> Guardar Toma';
  document.getElementById('formToma').scrollIntoView({behavior:'smooth'});
}

function cancelarToma(){document.getElementById('formToma').classList.add('d-none');}
function cerrarAhora(){const ahora=new Date();document.getElementById('fin').value=`${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;}

function setStars(n){
  estrellasValor=n;
  const stars=document.querySelectorAll('#estrellas span');
  stars.forEach((s,i)=>{s.textContent=i<n?'‚òÖ':'‚òÜ';});
  document.getElementById('estrellasTexto').textContent=`${n} estrellas`;
}

function guardarToma(){
  const fecha=new Date().toISOString().split('T')[0];
  const inicio=document.getElementById('inicio').value;
  const fin=document.getElementById('fin').value || null;
  const lado=document.getElementById('lado').value;
  const comentarios=document.getElementById('comentarios').value;

  const ahora=new Date();
  const nuevaToma={
    id:editId || Date.now(),
    fecha,
    hora_inicio:inicio,
    hora_fin:fin,
    estrellas:estrellasValor,
    lado,
    comentarios:comentarios || '',
    created_at:editId ? tomas.find(t=>t.id===editId).created_at : ahora.toISOString(),
    updated_at: ahora.toISOString()
  };

  if(editId){
    tomas=tomas.map(t=>t.id===editId?nuevaToma:t);
  } else tomas.unshift(nuevaToma);

  guardarDatos();
  renderizarTomas();
  actualizarResumen();
  actualizarInfo();
  actualizarEstadisticasDetalladas();
  cancelarToma();
}

function renderizarTomas(){
  const lista=document.getElementById('lista'); lista.innerHTML='';
  if(tomas.length===0){
    lista.innerHTML='<div class="text-center py-4 text-muted">Sin tomas registradas</div>'; return;
  }

  // Ordenar por fecha + hora_fin descendente
  const tomasOrdenadas = [...tomas].sort((a,b)=>{
    const fechaHoraA = new Date(`${a.fecha}T${a.hora_fin||a.hora_inicio}`);
    const fechaHoraB = new Date(`${b.fecha}T${b.hora_fin||b.hora_inicio}`);
    return fechaHoraB - fechaHoraA;
  });

  tomasOrdenadas.forEach(t=>{
    const item=document.createElement('div');
    const ladoFormateado = formatearLado(t.lado);
    const ladoClase = t.lado==='Izquierdo'||t.lado==='Izquierda'?'toma-izquierda':t.lado==='Derecho'||t.lado==='Derecha'?'toma-derecha':'toma-ambos';
    item.className=`list-group-item historial-item ${ladoClase}`;
    const fechaCompleta = formatearFechaCompleta(t.fecha);
    const horaTexto = t.hora_fin ? `${t.hora_inicio} - ${t.hora_fin}` : t.hora_inicio;
    item.innerHTML=`
      <div class="historial-item-header">
        <div class="historial-item-content">
          <div class="mb-1">
            <strong class="d-block">${fechaCompleta}</strong>
            <span class="text-muted">${horaTexto}</span>
            <span class="badge bg-light text-dark ms-2">${ladoFormateado}</span>
          </div>
          <div class="stars mb-1">${'‚òÖ'.repeat(t.estrellas)+'‚òÜ'.repeat(5-t.estrellas)}</div>
          ${t.comentarios?`<div class="text-muted"><small>${t.comentarios}</small></div>`:''}
        </div>
        <div class="historial-item-actions">
          <button class="btn btn-sm btn-outline-primary" onclick="editarToma(${t.id})" title="Editar">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="borrarToma(${t.id})" title="Eliminar">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
    lista.appendChild(item);
  });
}

function actualizarResumen(){
  const hoy=new Date().toISOString().split('T')[0];
  const tomasHoy = tomas
    .filter(t => t.fecha === hoy)
    .sort((a,b)=>{
      const fechaHoraA = new Date(`${a.fecha}T${a.hora_fin||a.hora_inicio}`);
      const fechaHoraB = new Date(`${b.fecha}T${b.hora_fin||b.hora_inicio}`);
      return fechaHoraB - fechaHoraA;
    });

  let totalMin=0;
  tomasHoy.forEach(t=>{if(t.hora_inicio&&t.hora_fin) totalMin+=calcularMinutos(t.hora_inicio,t.hora_fin);});
  const horas=Math.floor(totalMin/60); const minutos=totalMin%60;
  const ultima=tomasHoy.length>0?tomasHoy[0].hora_fin||tomasHoy[0].hora_inicio:'--:--';
  document.getElementById('totalTomas').textContent=tomasHoy.length;
  document.getElementById('tiempoTotal').textContent=`${horas}h ${minutos}m`;
  document.getElementById('ultimaToma').textContent=ultima;
}


function editarToma(id){
  const t=tomas.find(x=>x.id===id); if(!t)return;
  editId=id; document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML='<i class="bi bi-pencil"></i> Editar Toma';
  document.getElementById('inicio').value=t.hora_inicio;
  document.getElementById('fin').value=t.hora_fin||'';
  document.getElementById('comentarios').value=t.comentarios||'';
  document.getElementById('lado').value=t.lado;
  setStars(t.estrellas);
  document.getElementById('btnGuardar').innerHTML='<i class="bi bi-save"></i> Actualizar Toma';
  document.getElementById('formToma').scrollIntoView({behavior:'smooth'});
}

function borrarToma(id){
  if(!confirm('¬øEliminar esta toma?')) return;
  tomas=tomas.filter(t=>t.id!==id); guardarDatos(); renderizarTomas(); actualizarResumen(); actualizarInfo(); actualizarEstadisticasDetalladas();
}

function calcularMinutos(inicio,fin){
  if(!inicio||!fin)return 0;
  const [h1,m1]=inicio.split(':').map(Number); 
  const [h2,m2]=fin.split(':').map(Number);
  const minutosInicio = h1*60+m1;
  const minutosFin = h2*60+m2;
  let diferencia = minutosFin - minutosInicio;
  // Si la diferencia es negativa, significa que cruz√≥ la medianoche
  // Sumamos 24 horas (1440 minutos) para obtener el tiempo correcto
  if(diferencia < 0) diferencia += 1440;
  return diferencia;
}

/************ UTILIDADES ************/
function formatearFechaCompleta(fechaStr){
  const fecha = new Date(fechaStr + 'T00:00:00');
  return fecha.toLocaleDateString('es-ES', { 
    weekday: 'long', 
    day: 'numeric', 
    month: 'long' 
  });
}

function formatearLado(lado){
  const map = {
    'Izquierdo': 'Izquierda',
    'Derecho': 'Derecha',
    'Ambos': 'Ambas'
  };
  return map[lado] || lado;
}

/************ ESTAD√çSTICAS DETALLADAS ************/
function actualizarEstadisticasDetalladas(){
  if(tomas.length === 0){
    document.getElementById('estadisticasDetalladas').innerHTML = '<div class="text-center py-3 text-muted">No hay datos para mostrar estad√≠sticas</div>';
    return;
  }

  // Agrupar tomas por fecha
  const tomasPorFecha = {};
  tomas.forEach(t => {
    if(!tomasPorFecha[t.fecha]) tomasPorFecha[t.fecha] = [];
    tomasPorFecha[t.fecha].push(t);
  });

  // Calcular estad√≠sticas generales
  const fechas = Object.keys(tomasPorFecha).sort().reverse();
  const totalDias = fechas.length;
  const totalTomas = tomas.length;
  const totalMinutos = tomas.reduce((sum, t) => {
    if(t.hora_inicio && t.hora_fin) return sum + calcularMinutos(t.hora_inicio, t.hora_fin);
    return sum;
  }, 0);
  const totalHoras = Math.floor(Math.abs(totalMinutos) / 60);
  const minutosRestantes = Math.abs(totalMinutos) % 60;
  
  // Promedio de tomas por d√≠a
  const promedioTomasPorDia = (totalTomas / totalDias).toFixed(1);
  
  // Promedio de tiempo por toma
  const tomasConTiempo = tomas.filter(t => t.hora_inicio && t.hora_fin);
  const promedioMinutosPorToma = tomasConTiempo.length > 0 
    ? Math.round(tomasConTiempo.reduce((sum, t) => sum + calcularMinutos(t.hora_inicio, t.hora_fin), 0) / tomasConTiempo.length)
    : 0;
  
  // Distribuci√≥n por lado
  const ladoIzquierdo = tomas.filter(t => t.lado === 'Izquierdo' || t.lado === 'Izquierda').length;
  const ladoDerecho = tomas.filter(t => t.lado === 'Derecho' || t.lado === 'Derecha').length;
  const ladoAmbos = tomas.filter(t => t.lado === 'Ambos' || t.lado === 'Ambas').length;
  
  // Promedio de estrellas
  const promedioEstrellas = (tomas.reduce((sum, t) => sum + t.estrellas, 0) / totalTomas).toFixed(1);
  
  // D√≠a con m√°s tomas
  let maxTomas = 0;
  let fechaMaxTomas = '';
  fechas.forEach(fecha => {
    if(tomasPorFecha[fecha].length > maxTomas){
      maxTomas = tomasPorFecha[fecha].length;
      fechaMaxTomas = fecha;
    }
  });
  
  // D√≠a con m√°s tiempo
  let maxMinutos = 0;
  let fechaMaxTiempo = '';
  fechas.forEach(fecha => {
    const minutosDia = tomasPorFecha[fecha].reduce((sum, t) => {
      if(t.hora_inicio && t.hora_fin) return sum + calcularMinutos(t.hora_inicio, t.hora_fin);
      return sum;
    }, 0);
    const minutosDiaAbs = Math.abs(minutosDia);
    if(minutosDiaAbs > maxMinutos){
      maxMinutos = minutosDiaAbs;
      fechaMaxTiempo = fecha;
    }
  });
  
  // Formatear fecha para estad√≠sticas (formato corto)
  function formatearFecha(fechaStr){
    const fecha = new Date(fechaStr + 'T00:00:00');
    return fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
  }

  const html = `
    <div class="row g-3">
      <!-- Estad√≠sticas Generales -->
      <div class="col-12">
        <h6 class="mb-3"><i class="bi bi-info-circle"></i> Resumen General</h6>
        <div class="row text-center g-2">
          <div class="col-6 col-md-3">
            <div class="p-2 bg-light rounded">
              <div class="h5 mb-0">${totalDias}</div>
              <small class="text-muted">D√≠as</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-2 bg-light rounded">
              <div class="h5 mb-0">${totalTomas}</div>
              <small class="text-muted">Total Tomas</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-2 bg-light rounded">
              <div class="h5 mb-0">${totalHoras}h ${minutosRestantes}m</div>
              <small class="text-muted">Tiempo Total</small>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-2 bg-light rounded">
              <div class="h5 mb-0">${promedioTomasPorDia}</div>
              <small class="text-muted">Promedio/d√≠a</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Promedios -->
      <div class="col-12 col-md-6">
        <h6 class="mb-3"><i class="bi bi-calculator"></i> Promedios</h6>
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
            <span>Tiempo por toma</span>
            <strong>${promedioMinutosPorToma} min</strong>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
            <span>Calidad promedio</span>
            <strong>${promedioEstrellas} ‚≠ê</strong>
          </div>
        </div>
      </div>

      <!-- Distribuci√≥n por Lado -->
      <div class="col-12 col-md-6">
        <h6 class="mb-3"><i class="bi bi-symmetry-vertical"></i> Distribuci√≥n por Pecho</h6>
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
            <span>üëà Izquierda</span>
            <strong>${ladoIzquierdo} (${((ladoIzquierdo/totalTomas)*100).toFixed(1)}%)</strong>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
            <span>üëâ Derecha</span>
            <strong>${ladoDerecho} (${((ladoDerecho/totalTomas)*100).toFixed(1)}%)</strong>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
            <span>ü§≤ Ambas</span>
            <strong>${ladoAmbos} (${((ladoAmbos/totalTomas)*100).toFixed(1)}%)</strong>
          </div>
        </div>
      </div>

      <!-- R√©cords -->
      <div class="col-12">
        <h6 class="mb-3"><i class="bi bi-trophy"></i> R√©cords</h6>
        <div class="row g-2">
          <div class="col-12 col-md-6">
            <div class="p-3 bg-light rounded">
              <small class="text-muted d-block mb-1">D√≠a con m√°s tomas</small>
              <strong>${fechaMaxTomas ? formatearFecha(fechaMaxTomas) : 'N/A'}</strong>
              <div class="text-muted">${maxTomas} tomas</div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="p-3 bg-light rounded">
              <small class="text-muted d-block mb-1">D√≠a con m√°s tiempo</small>
              <strong>${fechaMaxTiempo ? formatearFecha(fechaMaxTiempo) : 'N/A'}</strong>
              <div class="text-muted">${Math.floor(maxMinutos/60)}h ${maxMinutos%60}m</div>
            </div>
          </div>
        </div>
      </div>

      <!-- √öltimos 7 d√≠as -->
      <div class="col-12">
        <h6 class="mb-3"><i class="bi bi-calendar-week"></i> √öltimos 7 D√≠as</h6>
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Fecha</th>
                <th class="text-center">Tomas</th>
                <th class="text-center">Tiempo</th>
                <th class="text-center">Promedio</th>
              </tr>
            </thead>
            <tbody>
              ${fechas.slice(0, 7).map(fecha => {
                const tomasDia = tomasPorFecha[fecha];
                const minutosDia = tomasDia.reduce((sum, t) => {
                  if(t.hora_inicio && t.hora_fin) return sum + calcularMinutos(t.hora_inicio, t.hora_fin);
                  return sum;
                }, 0);
                const promedioDia = tomasDia.length > 0 
                  ? Math.round(tomasDia.reduce((sum, t) => sum + t.estrellas, 0) / tomasDia.length * 10) / 10
                  : 0;
                const horasDia = Math.floor(Math.abs(minutosDia) / 60);
                const minutosRestantesDia = Math.abs(minutosDia) % 60;
                return `
                  <tr>
                    <td>${formatearFecha(fecha)}</td>
                    <td class="text-center">${tomasDia.length}</td>
                    <td class="text-center">${horasDia}h ${minutosRestantesDia}m</td>
                    <td class="text-center">${promedioDia} ‚≠ê</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('estadisticasDetalladas').innerHTML = html;
}

/************ SINCRONIZACI√ìN GITHUB ************/
function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(_,p1)=>String.fromCharCode('0x'+p1))); }
function b64DecodeUnicode(str){return decodeURIComponent(atob(str).split('').map(c=>'%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join(''));}

async function guardarDatosEnGitHub(){
  const url=`https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/milkometer.json`;
  const contenido=b64EncodeUnicode(JSON.stringify(tomas,null,2));

  let sha=null;
  try{
    const r=await fetch(url,{headers:{Authorization:`token ${config.githubToken}`}});
    if(r.ok){ const data=await r.json(); sha=data.sha; }
  }catch(e){ /* si no existe, se crea */ }

  const body={message:'Actualizar datos milk-o-meter', content:contenido};
  if(sha) body.sha=sha;

  const res=await fetch(url,{
    method:'PUT',
    headers:{Authorization:`token ${config.githubToken}`,'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  if(!res.ok) throw new Error('Error subiendo a GitHub');
}

async function sincronizarConGitHub(){
  if(!config || !config.githubUser || !config.githubToken) return;
  try{
    const url=`https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/milkometer.json`;
    const res=await fetch(url,{headers:{Authorization:`token ${config.githubToken}`}});
    if(res.ok){
      const data=await res.json();
      const remoto=b64DecodeUnicode(data.content);
      tomas=JSON.parse(remoto); guardarDatosLocales(); renderizarTomas(); actualizarResumen(); actualizarInfo(); actualizarEstadisticasDetalladas();
      actualizarSyncStatus('success','Sincronizado con GitHub');
    }
  }catch(e){ actualizarSyncStatus('danger','Error sincronizando'); }
}
</script>
</body>
</html>
