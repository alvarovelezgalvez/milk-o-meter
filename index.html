<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>milk-o-meter üçº</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{
      --baby-pink:#ffd6e7;
      --baby-blue:#dff3ff;
      --baby-mint:#e9fff5;
      --baby-purple:#efe7ff;
      --ink:#4a5568;
    }
    body{background:linear-gradient(180deg,var(--baby-blue),var(--baby-mint)); color:var(--ink); min-height:100vh}
    .card{border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); border:none}
    .btn-primary{background:#ff8fb3;border-color:#ff8fb3}
    .btn-primary:hover{background:#ff7aa5;border-color:#ff7aa5}
    .btn-success{background:#6bd1b3;border-color:#6bd1b3}
    .chip{background:var(--baby-purple); border-radius:999px; padding:.25rem .6rem; display:inline-block; font-size:0.85em}
    .stars span{cursor:pointer; user-select:none; font-size:1.8rem}
    .list-group-item{border-radius:1rem; margin-bottom:.5rem; border:none; background:rgba(255,255,255,0.9)}
    .star-filled{color:#ffc107}
    .star-empty{color:#ddd}
    .badge-estrella{background:#ffc107; color:#000}
    .toma-izquierda{border-left:4px solid #ff8fb3}
    .toma-derecha{border-left:4px solid #6bd1b3}
    .toma-ambos{border-left:4px solid #9d7aff}
    .sync-status{font-size:0.8em; opacity:0.8}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="container py-4" id="loginView">
  <div class="card p-4 mx-auto" style="max-width:400px">
    <div class="text-center mb-3">
      <h1 class="display-1">üçº</h1>
      <h3 class="mb-2">milk-o-meter</h3>
      <p class="text-muted">Seguimiento de tomas de Ariadna üíï</p>
    </div>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a familiar" autocomplete="off" />
    <button class="btn btn-primary w-100" onclick="login()">
      <i class="bi bi-door-open"></i> Entrar
    </button>
    <div class="mt-3 text-center">
      <small class="text-muted">Tu informaci√≥n se guarda de forma privada</small>
    </div>
  </div>
</div>

<!-- APP -->
<div class="container py-3 d-none" id="appView">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">milk-o-meter üçº</h3>
      <small class="sync-status" id="syncStatus">√öltima sincronizaci√≥n: --:--</small>
    </div>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-2" onclick="sincronizar()" id="btnSync">
        <i class="bi bi-cloud-arrow-up"></i>
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Resumen -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-graph-up"></i> Resumen de hoy
      </h6>
      <div class="row text-center">
        <div class="col">
          <div class="display-6" id="totalTomas">0</div>
          <small class="text-muted">Tomas</small>
        </div>
        <div class="col">
          <div class="display-6" id="tiempoTotal">0h 0m</div>
          <small class="text-muted">Tiempo</small>
        </div>
        <div class="col">
          <div class="display-6" id="ultimaToma">--:--</div>
          <small class="text-muted">√öltima</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√≥n Nueva Toma -->
  <button class="btn btn-success w-100 mb-3 py-3" onclick="nuevaToma()">
    <i class="bi bi-plus-circle"></i> Nueva Toma
  </button>

  <!-- Formulario Toma -->
  <div id="formToma" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title mb-3" id="formTitle">
        <i class="bi bi-clock-history"></i> Nueva Toma
      </h5>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-play-circle"></i> Hora inicio</label>
        <input type="time" id="inicio" class="form-control form-control-lg" required />
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-stop-circle"></i> Hora fin</label>
        <div class="input-group">
          <input type="time" id="fin" class="form-control" />
          <button class="btn btn-outline-secondary" type="button" onclick="cerrarAhora()">
            <i class="bi bi-clock"></i> Ahora
          </button>
        </div>
        <small class="text-muted">Dejar vac√≠o si a√∫n est√° tomando</small>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-star"></i> Cantidad</label>
        <div id="estrellas" class="stars text-center">
          <span onclick="setStars(1)">‚òÜ</span>
          <span onclick="setStars(2)">‚òÜ</span>
          <span onclick="setStars(3)">‚òÜ</span>
          <span onclick="setStars(4)">‚òÜ</span>
          <span onclick="setStars(5)">‚òÜ</span>
        </div>
        <div class="text-center mt-1">
          <span id="estrellasTexto" class="badge badge-estrella">0 estrellas</span>
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-symmetry-vertical"></i> Pecho</label>
        <select id="lado" class="form-select">
          <option value="izquierda">üëà Izquierdo</option>
          <option value="derecha">üëâ Derecho</option>
          <option value="ambos">ü§≤ Ambos</option>
        </select>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-chat-text"></i> Comentarios</label>
        <textarea id="comentarios" class="form-control" rows="2" placeholder="Notas, observaciones..."></textarea>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="guardarToma()" id="btnGuardar">
          <i class="bi bi-save"></i> Guardar Toma
        </button>
        <button class="btn btn-outline-danger" onclick="cancelarToma()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-list-check"></i> Historial de Tomas
      </h6>
      <div id="lista" class="list-group list-group-flush">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Cargando tomas...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export/Import Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Respaldo de datos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Guarda este c√≥digo para restaurar tus datos en otro dispositivo:</p>
        <textarea id="backupData" class="form-control mb-3" rows="6" readonly></textarea>
        <p>Para restaurar, pega el c√≥digo aqu√≠:</p>
        <textarea id="restoreData" class="form-control mb-3" rows="6" placeholder="Pega el c√≥digo de respaldo aqu√≠..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success" onclick="exportarDatos()">
          <i class="bi bi-download"></i> Exportar
        </button>
        <button type="button" class="btn btn-primary" onclick="importarDatos()">
          <i class="bi bi-upload"></i> Importar
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/************ CONFIGURACI√ìN ************/
const APP_PASSWORD = 'ari';
const STORAGE_KEY = 'milkometer_tomas_v2';
const SYNC_INTERVAL = 30000; // 30 segundos

/************ VARIABLES GLOBALES ************/
let tomas = [];
let editId = null;
let estrellasValor = 0;
let syncTimer = null;

/************ INICIALIZACI√ìN ************/
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus en contrase√±a
  const passwordField = document.getElementById('password');
  if (passwordField) {
    passwordField.focus();
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
  
  // Verificar si ya estamos autenticados
  if (localStorage.getItem('milkometer_auth') === 'true') {
    initApp();
  }
});

/************ AUTENTICACI√ìN ************/
function login() {
  const password = document.getElementById('password').value;
  if (password === APP_PASSWORD) {
    localStorage.setItem('milkometer_auth', 'true');
    initApp();
  } else {
    alert('Contrase√±a incorrecta. Pista: son las iniciales de tu beb√© üòâ');
    document.getElementById('password').focus();
    document.getElementById('password').select();
  }
}

function logout() {
  if (confirm('¬øSeguro que quieres salir?')) {
    localStorage.removeItem('milkometer_auth');
    location.reload();
  }
}

function initApp() {
  document.getElementById('loginView').classList.add('d-none');
  document.getElementById('appView').classList.remove('d-none');
  
  // Cargar datos
  cargarDatos();
  
  // Iniciar sincronizaci√≥n autom√°tica
  syncTimer = setInterval(sincronizar, SYNC_INTERVAL);
  
  // Actualizar estado de sincronizaci√≥n
  actualizarSyncStatus();
}

/************ GESTI√ìN DE DATOS ************/
function cargarDatos() {
  // Intentar cargar desde localStorage
  const datosGuardados = localStorage.getItem(STORAGE_KEY);
  if (datosGuardados) {
    try {
      tomas = JSON.parse(datosGuardados);
      console.log(`Cargadas ${tomas.length} tomas desde localStorage`);
    } catch (e) {
      console.error('Error cargando datos:', e);
      tomas = [];
    }
  }
  
  // Intentar cargar desde URL (para compartir datos)
  cargarDesdeURL();
  
  // Renderizar
  renderizarTomas();
  actualizarResumen();
}

function guardarDatos() {
  // Guardar en localStorage
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tomas));
  
  // Actualizar estado
  actualizarSyncStatus();
  
  // Tambi√©n guardar en URL (para compartir)
  guardarEnURL();
}

function cargarDesdeURL() {
  try {
    const hash = window.location.hash.substring(1);
    if (hash) {
      const datosURL = JSON.parse(atob(hash));
      if (Array.isArray(datosURL) && datosURL.length > tomas.length) {
        tomas = datosURL;
        console.log(`Cargadas ${tomas.length} tomas desde URL`);
      }
    }
  } catch (e) {
    // Silenciar error, no es cr√≠tico
  }
}

function guardarEnURL() {
  if (tomas.length > 0) {
    const datosCodificados = btoa(JSON.stringify(tomas));
    window.location.hash = datosCodificados;
  }
}

function sincronizar() {
  // En una app real, aqu√≠ se sincronizar√≠a con un servidor
  // Por ahora solo actualizamos el estado
  actualizarSyncStatus();
  document.getElementById('btnSync').innerHTML = '<i class="bi bi-cloud-check"></i>';
  setTimeout(() => {
    document.getElementById('btnSync').innerHTML = '<i class="bi bi-cloud-arrow-up"></i>';
  }, 1000);
}

function actualizarSyncStatus() {
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  document.getElementById('syncStatus').textContent = 
    `√öltima sincronizaci√≥n: ${hora}:${minutos} (${tomas.length} tomas)`;
}

/************ GESTI√ìN DE TOMAS ************/
function nuevaToma() {
  editId = null;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-clock-history"></i> Nueva Toma';
  
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  
  document.getElementById('inicio').value = `${hora}:${minutos}`;
  document.getElementById('fin').value = '';
  document.getElementById('comentarios').value = '';
  setStars(3); // Valor por defecto
  document.getElementById('lado').value = 'izquierda';
  document.getElementById('btnGuardar').innerHTML = '<i class="bi bi-save"></i> Guardar Toma';
  
  // Scroll suave al formulario
  document.getElementById('formToma').scrollIntoView({ behavior: 'smooth' });
}

function cancelarToma() {
  document.getElementById('formToma').classList.add('d-none');
}

function cerrarAhora() {
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  document.getElementById('fin').value = `${hora}:${minutos}`;
}

function setStars(n) {
  estrellasValor = n;
  const stars = document.querySelectorAll('#estrellas span');
  const texto = document.getElementById('estrellasTexto');
  
  stars.forEach((star, index) => {
    if (index < n) {
      star.textContent = '‚òÖ';
      star.className = 'star-filled';
    } else {
      star.textContent = '‚òÜ';
      star.className = 'star-empty';
    }
  });
  
  // Actualizar texto
  const textos = ['üòü Poca', 'üòê Regular', 'üôÇ Bien', 'üòä Muy bien', 'üòÑ Excelente'];
  texto.textContent = n > 0 ? textos[n-1] : 'Sin valorar';
}

function guardarToma() {
  const inicio = document.getElementById('inicio').value;
  const fin = document.getElementById('fin').value;
  const lado = document.getElementById('lado').value;
  const comentarios = document.getElementById('comentarios').value;
  
  if (!inicio) {
    alert('Por favor, ingresa la hora de inicio');
    return;
  }
  
  const ahora = new Date();
  const fecha = ahora.toISOString().split('T')[0];
  
  const nuevaToma = {
    id: editId || Date.now(),
    fecha: fecha,
    hora_inicio: inicio,
    hora_fin: fin || null,
    estrellas: estrellasValor,
    lado: lado,
    comentarios: comentarios || '',
    created_at: ahora.toISOString(),
    updated_at: ahora.toISOString()
  };
  
  if (editId) {
    // Editar toma existente
    const index = tomas.findIndex(t => t.id === editId);
    if (index !== -1) {
      nuevaToma.created_at = tomas[index].created_at;
      tomas[index] = nuevaToma;
    }
  } else {
    // Nueva toma
    tomas.unshift(nuevaToma);
  }
  
  // Guardar y renderizar
  guardarDatos();
  renderizarTomas();
  actualizarResumen();
  
  // Cerrar formulario
  document.getElementById('formToma').classList.add('d-none');
  
  // Mostrar confirmaci√≥n
  const toast = document.createElement('div');
  toast.className = 'position-fixed bottom-0 end-0 p-3';
  toast.innerHTML = `
    <div class="toast show" role="alert">
      <div class="toast-header bg-success text-white">
        <strong class="me-auto">‚úÖ Toma guardada</strong>
        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
      <div class="toast-body">
        ${editId ? 'Toma actualizada' : 'Nueva toma registrada'}
      </div>
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function editarToma(id) {
  const toma = tomas.find(t => t.id === id);
  if (!toma) return;
  
  editId = id;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Toma';
  
  document.getElementById('inicio').value = toma.hora_inicio;
  document.getElementById('fin').value = toma.hora_fin || '';
  setStars(toma.estrellas || 3);
  document.getElementById('lado').value = toma.lado;
  document.getElementById('comentarios').value = toma.comentarios || '';
  document.getElementById('btnGuardar').innerHTML = '<i class="bi bi-check-circle"></i> Actualizar';
  
  // Scroll suave al formulario
  document.getElementById('formToma').scrollIntoView({ behavior: 'smooth' });
}

function eliminarToma(id) {
  if (!confirm('¬øEliminar esta toma? Esta acci√≥n no se puede deshacer.')) {
    return;
  }
  
  tomas = tomas.filter(t => t.id !== id);
  guardarDatos();
  renderizarTomas();
  actualizarResumen();
}

/************ RENDERIZADO ************/
function renderizarTomas() {
  const lista = document.getElementById('lista');
  
  if (tomas.length === 0) {
    lista.innerHTML = `
      <div class="text-center py-5">
        <div class="display-1 text-muted mb-3">üçº</div>
        <h5>¬°No hay tomas registradas!</h5>
        <p class="text-muted">Haz clic en "Nueva Toma" para empezar.</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  // Agrupar por fecha
  const tomasPorFecha = {};
  tomas.forEach(toma => {
    const fecha = toma.fecha;
    if (!tomasPorFecha[fecha]) {
      tomasPorFecha[fecha] = [];
    }
    tomasPorFecha[fecha].push(toma);
  });
  
  // Ordenar fechas (m√°s reciente primero)
  const fechas = Object.keys(tomasPorFecha).sort((a, b) => b.localeCompare(a));
  
  fechas.forEach(fecha => {
    // Formatear fecha bonita
    const fechaObj = new Date(fecha);
    const hoy = new Date().toISOString().split('T')[0];
    const ayer = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    
    let fechaTexto;
    if (fecha === hoy) fechaTexto = 'Hoy';
    else if (fecha === ayer) fechaTexto = 'Ayer';
    else fechaTexto = fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    
    html += `
      <div class="mb-3">
        <h6 class="text-muted mb-2"><i class="bi bi-calendar"></i> ${fechaTexto}</h6>
    `;
    
    tomasPorFecha[fecha].forEach(toma => {
      const claseLado = `toma-${toma.lado}`;
      const iconoLado = {
        'izquierda': 'üëà',
        'derecha': 'üëâ',
        'ambos': 'ü§≤'
      }[toma.lado] || 'ü§±';
      
      const estrellasHTML = toma.estrellas ? 
        `<span class="badge bg-warning text-dark ms-2"><i class="bi bi-star-fill"></i> ${toma.estrellas}</span>` : '';
      
      const duracion = calcularDuracion(toma.hora_inicio, toma.hora_fin);
      
      html += `
        <div class="list-group-item ${claseLado}">
          <div class="d-flex justify-content-between align-items-center">
            <div style="flex: 1;">
              <div class="d-flex align-items-center mb-1">
                <span class="chip me-2">${iconoLado}</span>
                <strong>${toma.hora_inicio}</strong>
                ${toma.hora_fin ? `<span class="mx-1">‚Üí</span><strong>${toma.hora_fin}</strong>` : ''}
                ${duracion ? `<span class="badge bg-info ms-2">${duracion}</span>` : ''}
                ${estrellasHTML}
              </div>
              ${toma.comentarios ? `
                <div class="mt-1 text-muted">
                  <small><i class="bi bi-chat-left"></i> ${toma.comentarios}</small>
                </div>
              ` : ''}
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editarToma(${toma.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="eliminarToma(${toma.id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  lista.innerHTML = html;
}

function actualizarResumen() {
  const hoy = new Date().toISOString().split('T')[0];
  const tomasHoy = tomas.filter(t => t.fecha === hoy);
  
  // Calcular tiempo total
  let totalMinutos = 0;
  tomasHoy.forEach(t => {
    if (t.hora_inicio && t.hora_fin) {
      const minutos = calcularMinutos(t.hora_inicio, t.hora_fin);
      if (minutos > 0) totalMinutos += minutos;
    }
  });
  
  // √öltima toma
  let ultimaToma = '--:--';
  if (tomasHoy.length > 0) {
    const ultima = tomasHoy.reduce((latest, toma) => {
      return toma.hora_inicio > latest.hora_inicio ? toma : latest;
    });
    ultimaToma = ultima.hora_inicio;
  }
  
  // Actualizar UI
  document.getElementById('totalTomas').textContent = tomasHoy.length;
  document.getElementById('tiempoTotal').textContent = 
    `${Math.floor(totalMinutos/60)}h ${totalMinutos%60}m`;
  document.getElementById('ultimaToma').textContent = ultimaToma;
}

/************ UTILIDADES ************/
function calcularMinutos(inicio, fin) {
  if (!inicio || !fin) return 0;
  
  try {
    const [h1, m1] = inicio.split(':').map(Number);
    const [h2, m2] = fin.split(':').map(Number);
    return (h2 * 60 + m2) - (h1 * 60 + m1);
  } catch (e) {
    return 0;
  }
}

function calcularDuracion(inicio, fin) {
  if (!inicio || !fin) return '';
  
  const minutos = calcularMinutos(inicio, fin);
  if (minutos <= 0) return '';
  
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  
  if (horas > 0) {
    return `${horas}h ${mins}m`;
  } else {
    return `${mins}m`;
  }
}

/************ EXPORTAR/IMPORTAR ************/
function exportarDatos() {
  const datosCodificados = btoa(JSON.stringify(tomas));
  document.getElementById('backupData').value = datosCodificados;
  
  // Tambi√©n copiar al portapapeles
  navigator.clipboard.writeText(datosCodificados).then(() => {
    alert('Datos copiados al portapapeles. ¬°Gu√°rdalos en un lugar seguro!');
  });
}

function importarDatos() {
  const datos = document.getElementById('restoreData').value.trim();
  if (!datos) {
    alert('Por favor, pega el c√≥digo de respaldo');
    return;
  }
  
  try {
    const datosImportados = JSON.parse(atob(datos));
    if (Array.isArray(datosImportados)) {
      // Mezclar con datos existentes, evitando duplicados
      const idsExistentes = new Set(tomas.map(t => t.id));
      datosImportados.forEach(toma => {
        if (!idsExistentes.has(toma.id)) {
          tomas.push(toma);
        }
      });
      
      // Ordenar por fecha
      tomas.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      guardarDatos();
      renderizarTomas();
      actualizarResumen();
      
      // Cerrar modal
      bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
      alert(`¬°Datos importados! Ahora tienes ${tomas.length} tomas.`);
    } else {
      alert('Formato de datos incorrecto');
    }
  } catch (e) {
    alert('Error importando datos: ' + e.message);
  }
}

/************ COMPARTIR ************/
function mostrarBackupModal() {
  const modal = new bootstrap.Modal(document.getElementById('backupModal'));
  modal.show();
}

// Exponer funciones globalmente
window.login = login;
window.logout = logout;
window.nuevaToma = nuevaToma;
window.cancelarToma = cancelarToma;
window.cerrarAhora = cerrarAhora;
window.setStars = setStars;
window.guardarToma = guardarToma;
window.editarToma = editarToma;
window.eliminarToma = eliminarToma;
window.sincronizar = sincronizar;
window.exportarDatos = exportarDatos;
window.importarDatos = importarDatos;
window.mostrarBackupModal = mostrarBackupModal;
</script>
</body>
</html>
