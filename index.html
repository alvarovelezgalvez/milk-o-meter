<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>milk-o-meter üçº</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{
      --baby-pink:#ffd6e7;
      --baby-blue:#dff3ff;
      --baby-mint:#e9fff5;
      --baby-purple:#efe7ff;
      --ink:#4a5568;
    }
    body{background:linear-gradient(180deg,var(--baby-blue),var(--baby-mint)); color:var(--ink); min-height:100vh}
    .card{border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); border:none}
    .btn-primary{background:#ff8fb3;border-color:#ff8fb3}
    .btn-primary:hover{background:#ff7aa5;border-color:#ff7aa5}
    .btn-success{background:#6bd1b3;border-color:#6bd1b3}
    .chip{background:var(--baby-purple); border-radius:999px; padding:.25rem .6rem; display:inline-block; font-size:0.85em}
    .stars span{cursor:pointer; user-select:none; font-size:1.8rem}
    .list-group-item{border-radius:1rem; margin-bottom:.5rem; border:none; background:rgba(255,255,255,0.9)}
    .star-filled{color:#ffc107}
    .star-empty{color:#ddd}
    .badge-estrella{background:#ffc107; color:#000}
    .toma-izquierda{border-left:4px solid #ff8fb3}
    .toma-derecha{border-left:4px solid #6bd1b3}
    .toma-ambos{border-left:4px solid #9d7aff}
    .connection-badge{font-size:0.75em}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="container py-4" id="loginView">
  <div class="card p-4 mx-auto" style="max-width:400px">
    <div class="text-center mb-3">
      <h1 class="display-1">üçº</h1>
      <h3 class="mb-2">milk-o-meter</h3>
      <p class="text-muted">Seguimiento de tomas de Ariadna üíï</p>
    </div>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a" autocomplete="off" />
    <button class="btn btn-primary w-100" onclick="login()">
      <i class="bi bi-door-open"></i> Entrar
    </button>
    <div class="mt-3 text-center">
      <small class="text-muted">Contrase√±a: ari</small>
    </div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="modal fade" id="configModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear"></i> Configuraci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Configura estos datos una sola vez para sincronizar entre dispositivos</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Tu usuario de GitHub</label>
          <input type="text" id="githubUser" class="form-control" placeholder="ej: tuusuario" />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Nombre del repositorio</label>
          <input type="text" id="repoName" class="form-control" placeholder="ej: milk-o-meter" value="milk-o-meter" />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Token de GitHub (solo visible una vez)</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
          <small class="text-muted">
            <a href="https://github.com/settings/tokens" target="_blank">Crear token aqu√≠</a> (permisos: repo)
          </small>
        </div>
        
        <div class="alert alert-warning">
          <small><i class="bi bi-exclamation-triangle"></i> <strong>Instrucciones:</strong>
          <ol class="mb-0">
            <li>Crea repositorio en GitHub (p√∫blico o privado)</li>
            <li>Crea token en GitHub con permisos "repo"</li>
            <li>Introduce los datos aqu√≠</li>
            <li>¬°Listo! Los datos se sincronizar√°n autom√°ticamente</li>
          </ol>
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarConfig()">
          <i class="bi bi-save"></i> Guardar configuraci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="container py-3 d-none" id="appView">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">milk-o-meter üçº</h3>
      <div class="connection-badge">
        <span class="badge" id="syncStatus">‚óè Desconectado</span>
        <small class="text-muted ms-2" id="lastSync">--:--</small>
      </div>
    </div>
    <div>
      <button class="btn btn-outline-info btn-sm me-2" onclick="mostrarConfig()">
        <i class="bi bi-gear"></i>
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Resumen -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-graph-up"></i> Resumen de hoy
      </h6>
      <div class="row text-center">
        <div class="col">
          <div class="display-6" id="totalTomas">0</div>
          <small class="text-muted">Tomas</small>
        </div>
        <div class="col">
          <div class="display-6" id="tiempoTotal">0h 0m</div>
          <small class="text-muted">Tiempo</small>
        </div>
        <div class="col">
          <div class="display-6" id="ultimaToma">--:--</div>
          <small class="text-muted">√öltima</small>
        </div>
      </div>
      <div class="mt-2 text-center">
        <small class="text-muted" id="totalRegistros">Cargando...</small>
      </div>
    </div>
  </div>

  <!-- Bot√≥n Nueva Toma -->
  <button class="btn btn-success w-100 mb-3 py-3" onclick="nuevaToma()">
    <i class="bi bi-plus-circle"></i> Nueva Toma
  </button>

  <!-- Formulario Toma -->
  <div id="formToma" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title mb-3" id="formTitle">
        <i class="bi bi-clock-history"></i> Nueva Toma
      </h5>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-play-circle"></i> Hora inicio</label>
        <input type="time" id="inicio" class="form-control form-control-lg" required />
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-stop-circle"></i> Hora fin</label>
        <div class="input-group">
          <input type="time" id="fin" class="form-control" />
          <button class="btn btn-outline-secondary" type="button" onclick="cerrarAhora()">
            <i class="bi bi-clock"></i> Ahora
          </button>
        </div>
        <small class="text-muted">Dejar vac√≠o si a√∫n est√° tomando</small>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-star"></i> Cantidad</label>
        <div id="estrellas" class="stars text-center">
          <span onclick="setStars(1)">‚òÜ</span>
          <span onclick="setStars(2)">‚òÜ</span>
          <span onclick="setStars(3)">‚òÜ</span>
          <span onclick="setStars(4)">‚òÜ</span>
          <span onclick="setStars(5)">‚òÜ</span>
        </div>
        <div class="text-center mt-1">
          <span id="estrellasTexto" class="badge badge-estrella">0 estrellas</span>
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-symmetry-vertical"></i> Pecho</label>
        <select id="lado" class="form-select">
          <option value="Izquierdo">üëà Izquierdo</option>
          <option value="Derecho">üëâ Derecho</option>
          <option value="Ambos">ü§≤ Ambos</option>
        </select>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-chat-text"></i> Comentarios</label>
        <textarea id="comentarios" class="form-control" rows="2" placeholder="Notas, observaciones..."></textarea>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="guardarToma()" id="btnGuardar">
          <i class="bi bi-save"></i> Guardar Toma
        </button>
        <button class="btn btn-outline-danger" onclick="cancelarToma()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-list-check"></i> Historial de Tomas
      </h6>
      <div id="lista" class="list-group list-group-flush">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Cargando tomas...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/************ CONFIGURACI√ìN ************/
const APP_PASSWORD = 'ari';
const CONFIG_KEY = 'milkometer_config_v1';
const DATA_KEY = 'milkometer_local_data_v1';

// Datos hist√≥ricos (tus 30 tomas originales)
const DATOS_HISTORICOS = [
  {"id":1,"fecha":"2025-12-10","hora_inicio":"08:00","hora_fin":"08:30","estrellas":5,"lado":"Ambos","comentarios":"Primera toma buena","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":2,"fecha":"2025-12-10","hora_inicio":"08:30","hora_fin":"09:00","estrellas":5,"lado":"Ambos","comentarios":"Segunda toma buena","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":3,"fecha":"2025-12-10","hora_inicio":"12:00","hora_fin":"12:15","estrellas":4,"lado":"Ambos","comentarios":"Toma ofrecida, parada por sue√±o","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":4,"fecha":"2025-12-10","hora_inicio":"14:00","hora_fin":"14:15","estrellas":4,"lado":"Ambos","comentarios":"Toma ofrecida, parada por sue√±o","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":5,"fecha":"2025-12-10","hora_inicio":"15:32","hora_fin":"15:57","estrellas":4,"lado":"Derecho","comentarios":"Se queda dormida pero apura teta derecha","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":6,"fecha":"2025-12-10","hora_inicio":"18:30","hora_fin":"19:02","estrellas":5,"lado":"Izquierdo","comentarios":"Se acaba durmiendo","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":7,"fecha":"2025-12-10","hora_inicio":"19:52","hora_fin":"20:18","estrellas":5,"lado":"Derecho","comentarios":"Con prueba del tal√≥n y vacuna de por medio","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":8,"fecha":"2025-12-11","hora_inicio":"01:18","hora_fin":"01:33","estrellas":5,"lado":"Derecho","comentarios":"10-15 minutos","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":9,"fecha":"2025-12-11","hora_inicio":"04:44","hora_fin":"05:45","estrellas":5,"lado":"Izquierdo","comentarios":"Muy bien esta toma","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":10,"fecha":"2025-12-11","hora_inicio":"10:30","hora_fin":"10:30","estrellas":2,"lado":"Ambos","comentarios":"No quiso comer","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":11,"fecha":"2025-12-11","hora_inicio":"12:00","hora_fin":"12:30","estrellas":5,"lado":"Ambos","comentarios":"Media hora, estuvo en los dos pechos","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":12,"fecha":"2025-12-11","hora_inicio":"13:55","hora_fin":"14:10","estrellas":5,"lado":"Izquierdo","comentarios":"Pecho izquierdo","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":13,"fecha":"2025-12-11","hora_inicio":"15:08","hora_fin":"15:40","estrellas":5,"lado":"Derecho","comentarios":"Pecho derecho","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":14,"fecha":"2025-12-11","hora_inicio":"17:50","hora_fin":"18:00","estrellas":4,"lado":"Derecho","comentarios":"Pecho derecho","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":15,"fecha":"2025-12-11","hora_inicio":"20:30","hora_fin":"21:00","estrellas":5,"lado":"Ambos","comentarios":"15' pecho izquierdo y 15' derecho, ahora ya es leche","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":16,"fecha":"2025-12-11,"hora_inicio":"21:52","hora_fin":"22:09","estrellas":5,"lado":"Izquierdo","comentarios":"Pecho izquierdo","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":17,"fecha":"2025-12-11","hora_inicio":"23:50","hora_fin":"00:25","estrellas":5,"lado":"Derecho","comentarios":"Teta derecha","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":18,"fecha":"2025-12-12","hora_inicio":"01:15","hora_fin":"01:30","estrellas":5,"lado":"Izquierdo","comentarios":"Teta izquierda","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":19,"fecha":"2025-12-12","hora_inicio":"03:35","hora_fin":"03:50","estrellas":4,"lado":"Derecho","comentarios":"No ha dormido entre medias, le suenan las tripas, no est√° comiendo mucho","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":20,"fecha":"2025-12-12","hora_inicio":"10:00","hora_fin":"10:28","estrellas":5,"lado":"Derecho","comentarios":"Teta derecha","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":21,"fecha":"2025-12-12","hora_inicio":"11:07","hora_fin":"11:25","estrellas":5,"lado":"Izquierdo","comentarios":"Dejando algunas gotas primero","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":22,"fecha":"2025-12-12","hora_inicio":"12:34","hora_fin":"12:55","estrellas":5,"lado":"Derecho","comentarios":"Todo bien","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":23,"fecha":"2025-12-12","hora_inicio":"14:22","hora_fin":"14:38","estrellas":4,"lado":"Izquierdo","comentarios":null,"created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":24,"fecha":"2025-12-12","hora_inicio":"17:38","hora_fin":"18:14","estrellas":5,"lado":"Derecho","comentarios":null,"created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":25,"fecha":"2025-12-12","hora_inicio":"19:14","hora_fin":"19:30","estrellas":4,"lado":"Izquierdo","comentarios":"No a tope pero bien","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":26,"fecha":"2025-12-12","hora_inicio":"21:14","hora_fin":"21:50","estrellas":5,"lado":"Derecho","comentarios":"Muy bien","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":27,"fecha":"2025-12-12","hora_inicio":"23:35","hora_fin":"00:00","estrellas":4,"lado":"Izquierdo","comentarios":"Se queda dormida, extra mimo","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":28,"fecha":"2025-12-13","hora_inicio":"01:41","hora_fin":"01:56","estrellas":4,"lado":"Derecho","comentarios":"+14 ducha, medio dormida","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":29,"fecha":"2025-12-13","hora_inicio":"03:30","hora_fin":"03:45","estrellas":5,"lado":"Ambos","comentarios":"Izda mimo + derecha 15 min, extra","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"},
  {"id":30,"fecha":"2025-12-13","hora_inicio":"04:05","hora_fin":"04:22","estrellas":4,"lado":"Izquierdo","comentarios":"Medio","created_at":"2025-12-13T17:29:16.372Z","updated_at":"2025-12-13T17:29:16.372Z"}
];

/************ VARIABLES GLOBALES ************/
let tomas = [];
let editId = null;
let estrellasValor = 3;
let config = null;
let syncInterval = null;

/************ INICIALIZACI√ìN ************/
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus en contrase√±a
  const passwordField = document.getElementById('password');
  if (passwordField) {
    passwordField.focus();
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
  
  // Verificar si ya estamos autenticados
  if (localStorage.getItem('milkometer_auth') === 'true') {
    initApp();
  }
});

/************ AUTENTICACI√ìN ************/
function login() {
  const password = document.getElementById('password').value;
  if (password === APP_PASSWORD) {
    localStorage.setItem('milkometer_auth', 'true');
    initApp();
  } else {
    alert('Contrase√±a incorrecta');
    document.getElementById('password').focus();
    document.getElementById('password').select();
  }
}

function logout() {
  if (confirm('¬øSeguro que quieres salir?')) {
    localStorage.removeItem('milkometer_auth');
    clearInterval(syncInterval);
    location.reload();
  }
}

async function initApp() {
  document.getElementById('loginView').classList.add('d-none');
  document.getElementById('appView').classList.remove('d-none');
  
  // Cargar configuraci√≥n
  cargarConfig();
  
  // Cargar datos iniciales
  await cargarDatos();
  
  // Iniciar sincronizaci√≥n autom√°tica cada 30 segundos
  syncInterval = setInterval(sincronizarConGitHub, 30000);
}

/************ CONFIGURACI√ìN GITHUB ************/
function cargarConfig() {
  const configGuardada = localStorage.getItem(CONFIG_KEY);
  if (configGuardada) {
    try {
      config = JSON.parse(configGuardada);
      console.log('Configuraci√≥n cargada:', config);
    } catch (e) {
      console.error('Error cargando configuraci√≥n:', e);
      config = null;
    }
  }
  
  // Si no hay configuraci√≥n, mostrar modal
  if (!config || !config.githubUser || !config.githubToken) {
    setTimeout(() => mostrarConfig(), 1000);
  }
}

function guardarConfig() {
  const githubUser = document.getElementById('githubUser').value.trim();
  const repoName = document.getElementById('repoName').value.trim() || 'milk-o-meter';
  const githubToken = document.getElementById('githubToken').value.trim();
  
  if (!githubUser || !githubToken) {
    alert('Por favor, completa todos los campos');
    return;
  }
  
  config = {
    githubUser,
    repoName,
    githubToken,
    configuredAt: new Date().toISOString()
  };
  
  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
  if (modal) modal.hide();
  
  alert('‚úÖ Configuraci√≥n guardada. Ahora se sincronizar√° con GitHub.');
  
  // Forzar sincronizaci√≥n inicial
  sincronizarConGitHub();
}

function mostrarConfig() {
  const modal = new bootstrap.Modal(document.getElementById('configModal'));
  
  if (config) {
    document.getElementById('githubUser').value = config.githubUser || '';
    document.getElementById('repoName').value = config.repoName || 'milk-o-meter';
    document.getElementById('githubToken').value = config.githubToken || '';
  }
  
  modal.show();
}

/************ GESTI√ìN DE DATOS CON GITHUB ************/
async function cargarDatos() {
  // Primero intentar cargar desde GitHub
  let datosGitHub = [];
  
  if (config && config.githubUser && config.githubToken) {
    try {
      datosGitHub = await obtenerDatosDeGitHub();
      if (datosGitHub.length > 0) {
        tomas = datosGitHub;
        actualizarSyncStatus('success', 'Sincronizado con GitHub');
        console.log(`Cargadas ${tomas.length} tomas desde GitHub`);
      }
    } catch (error) {
      console.warn('No se pudo cargar desde GitHub:', error);
      // Continuar con datos locales
    }
  }
  
  // Si no hay datos en GitHub, cargar locales
  if (tomas.length === 0) {
    const datosLocales = localStorage.getItem(DATA_KEY);
    if (datosLocales) {
      try {
        tomas = JSON.parse(datosLocales);
        console.log(`Cargadas ${tomas.length} tomas desde localStorage`);
      } catch (e) {
        console.error('Error cargando datos locales:', e);
        tomas = [];
      }
    }
  }
  
  // Si a√∫n no hay datos, cargar hist√≥ricos
  if (tomas.length === 0) {
    tomas = [...DATOS_HISTORICOS];
    console.log(`Cargadas ${tomas.length} tomas hist√≥ricas`);
  }
  
  // Guardar datos localmente como backup
  guardarDatosLocales();
  
  // Renderizar
  renderizarTomas();
  actualizarResumen();
  actualizarInfo();
}

async function guardarDatos() {
  // Guardar localmente primero (siempre disponible)
  guardarDatosLocales();
  
  // Intentar sincronizar con GitHub
  if (config && config.githubUser && config.githubToken) {
    try {
      await guardarDatosEnGitHub();
      actualizarSyncStatus('success', 'Guardado en GitHub');
    } catch (error) {
      console.warn('No se pudo guardar en GitHub:', error);
      actualizarSyncStatus('warning', 'Guardado localmente (sin conexi√≥n)');
    }
  } else {
    actualizarSyncStatus('warning', 'Guardado localmente (sin configuraci√≥n GitHub)');
  }
}

function guardarDatosLocales() {
  localStorage.setItem(DATA_KEY, JSON.stringify(tomas));
}

async function sincronizarConGitHub() {
  if (!config || !config.githubUser || !config.githubToken) {
    return;
  }
  
  try {
    const datosRemotos = await obtenerDatosDeGitHub();
    
    if (datosRemotos.length === 0) {
      // No hay datos remotos, subir los locales
      await guardarDatosEnGitHub();
    } else {
      // Sincronizar: combinar datos locales y remotos
      const idsLocales = new Set(tomas.map(t => t.id));
      const idsRemotos = new Set(datosRemotos.map(t => t.id));
      
      // A√±adir datos remotos que no tenemos localmente
      datosRemotos.forEach(tomaRemota => {
        if (!idsLocales.has(tomaRemota.id)) {
          tomas.push(tomaRemota);
        }
      });
      
      // Actualizar datos locales que sean m√°s recientes
      tomas.forEach((tomaLocal, index) => {
        const tomaRemota = datosRemotos.find(t => t.id === tomaLocal.id);
        if (tomaRemota) {
          const fechaLocal = new Date(tomaLocal.updated_at || tomaLocal.created_at);
          const fechaRemota = new Date(tomaRemota.updated_at || tomaRemota.created_at);
          
          if (fechaRemota > fechaLocal) {
            // El dato remoto es m√°s reciente
            tomas[index] = tomaRemota;
          }
        }
      });
      
      // Ordenar por fecha
      tomas.sort((a, b) => {
        const fechaA = new Date(a.updated_at || a.created_at);
        const fechaB = new Date(b.updated_at || b.created_at);
        return fechaB - fechaA;
      });
      
      // Guardar cambios
      guardarDatosLocales();
      renderizarTomas();
      actualizarResumen();
    }
    
    actualizarSyncStatus('success', 'Sincronizado');
  } catch (error) {
    console.warn('Error sincronizando:', error);
    actualizarSyncStatus('danger', 'Error de sincronizaci√≥n');
  }
}

/************ API GITHUB ************/
async function obtenerDatosDeGitHub() {
  if (!config) return [];
  
  try {
    const url = `https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/tomas.json`;
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `token ${config.githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      const contenido = atob(data.content);
      return JSON.parse(contenido);
    } else if (response.status === 404) {
      // El archivo no existe a√∫n
      return [];
    } else {
      throw new Error(`GitHub API error: ${response.status}`);
    }
  } catch (error) {
    console.error('Error obteniendo datos de GitHub:', error);
    throw error;
  }
}

async function guardarDatosEnGitHub() {
  if (!config) return;
  
  try {
    const url = `https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/tomas.json`;
    
    // Primero obtener el SHA del archivo actual (si existe)
    let sha = null;
    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${config.githubToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        sha = data.sha;
      }
    } catch (e) {
      // El archivo no existe a√∫n, no hay problema
    }
    
    // Preparar datos
    const contenido = JSON.stringify(tomas, null, 2);
    const contenidoCodificado = btoa(contenido);
    
    const body = {
      message: `Actualizaci√≥n tomas ${new Date().toLocaleString()}`,
      content: contenidoCodificado,
      sha: sha
    };
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${config.githubToken}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status}`);
    }
    
    return true;
  } catch (error) {
    console.error('Error guardando datos en GitHub:', error);
    throw error;
  }
}

/************ INTERFAZ ************/
function actualizarSyncStatus(status, texto) {
  const statusElement = document.getElementById('syncStatus');
  const badgeClass = {
    'success': 'bg-success',
    'warning': 'bg-warning',
    'danger': 'bg-danger'
  }[status] || 'bg-secondary';
  
  statusElement.className = `badge ${badgeClass}`;
  statusElement.textContent = `‚óè ${texto}`;
  
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  document.getElementById('lastSync').textContent = `${hora}:${minutos}`;
}

function actualizarInfo() {
  const hoy = new Date().toISOString().split('T')[0];
  const tomasHoy = tomas.filter(t => t.fecha === hoy).length;
  const totalTomas = tomas.length;
  
  document.getElementById('totalRegistros').textContent = 
    `${tomasHoy} tomas hoy | ${totalTomas} en total`;
}

// ... (las funciones de gesti√≥n de tomas, renderizado, etc. son las mismas que antes)
// Solo necesito agregar las funciones b√°sicas de UI aqu√≠:

function nuevaToma() {
  editId = null;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-clock-history"></i> Nueva Toma';
  
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  
  document.getElementById('inicio').value = `${hora}:${minutos}`;
  document.getElementById('fin').value = '';
  document.getElementById('comentarios').value = '';
  setStars(3);
  document.getElementById('lado').value = 'Izquierdo';
  document.getElementById('btnGuardar').innerHTML = '<i class="bi bi-save"></i> Guardar Toma';
  
  document.getElementById('formToma').scrollIntoView({ behavior: 'smooth' });
}

function cancelarToma() {
  document.getElementById('formToma').classList.add('d-none');
}

function cerrarAhora() {
  const ahora = new Date();
  const hora = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  document.getElementById('fin').value = `${hora}:${minutos}`;
}

function setStars(n) {
  estrellasValor = n;
  const stars = document.querySelectorAll('#estrellas span');
  const texto = document.getElementById('estrellasTexto');
  
  stars.forEach((star, index) => {
    if (index < n) {
      star.textContent = '‚òÖ';
      star.className = 'star-filled';
    } else {
      star.textContent = '‚òÜ';
      star.className = 'star-empty';
    }
  });
  
  const textos = ['üòü Poca', 'üòê Regular', 'üôÇ Bien', 'üòä Muy bien', 'üòÑ Excelente'];
  texto.textContent = n > 0 ? textos[n-1] : 'Sin valorar';
}

async function guardarToma() {
  const inicio = document.getElementById('inicio').value;
  const fin = document.getElementById('fin').value;
  const lado = document.getElementById('lado').value;
  const comentarios = document.getElementById('comentarios').value;
  
  if (!inicio) {
    alert('Por favor, ingresa la hora de inicio');
    return;
  }
  
  const ahora = new Date();
  const fecha = ahora.toISOString().split('T')[0];
  
  const nuevaToma = {
    id: editId || Date.now(),
    fecha: fecha,
    hora_inicio: inicio,
    hora_fin: fin || null,
    estrellas: estrellasValor,
    lado: lado,
    comentarios: comentarios || '',
    created_at: editId ? undefined : ahora.toISOString(),
    updated_at: ahora.toISOString()
  };
  
  if (editId) {
    const index = tomas.findIndex(t => t.id === editId);
    if (index !== -1) {
      nuevaToma.created_at = tomas[index].created_at;
      tomas[index] = nuevaToma;
    }
  } else {
    tomas.unshift(nuevaToma);
  }
  
  await guardarDatos();
  renderizarTomas();
  actualizarResumen();
  actualizarInfo();
  
  document.getElementById('formToma').classList.add('d-none');
  mostrarNotificacion(editId ? 'Toma actualizada ‚úì' : 'Nueva toma guardada ‚úì');
}

function editarToma(id) {
  const toma = tomas.find(t => t.id === id);
  if (!toma) return;
  
  editId = id;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Toma';
  
  document.getElementById('inicio').value = toma.hora_inicio;
  document.getElementById('fin').value = toma.hora_fin || '';
  setStars(toma.estrellas || 3);
  document.getElementById('lado').value = toma.lado;
  document.getElementById('comentarios').value = toma.comentarios || '';
  document.getElementById('btnGuardar').innerHTML = '<i class="bi bi-check-circle"></i> Actualizar';
  
  document.getElementById('formToma').scrollIntoView({ behavior: 'smooth' });
}

function eliminarToma(id) {
  if (!confirm('¬øEliminar esta toma?')) return;
  
  tomas = tomas.filter(t => t.id !== id);
  guardarDatos();
  renderizarTomas();
  actualizarResumen();
  actualizarInfo();
  mostrarNotificacion('Toma eliminada');
}

function renderizarTomas() {
  const lista = document.getElementById('lista');
  
  if (tomas.length === 0) {
    lista.innerHTML = `
      <div class="text-center py-5">
        <div class="display-1 text-muted mb-3">üçº</div>
        <h5>¬°No hay tomas registradas!</h5>
        <p class="text-muted">Haz clic en "Nueva Toma" para empezar.</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  const tomasPorFecha = {};
  
  tomas.forEach(toma => {
    const fecha = toma.fecha;
    if (!tomasPorFecha[fecha]) {
      tomasPorFecha[fecha] = [];
    }
    tomasPorFecha[fecha].push(toma);
  });
  
  const fechas = Object.keys(tomasPorFecha).sort((a, b) => b.localeCompare(a));
  
  fechas.forEach(fecha => {
    const fechaObj = new Date(fecha);
    const hoy = new Date().toISOString().split('T')[0];
    const ayer = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    
    let fechaTexto;
    if (fecha === hoy) fechaTexto = 'Hoy';
    else if (fecha === ayer) fechaTexto = 'Ayer';
    else fechaTexto = fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    
    html += `<div class="mb-3"><h6 class="text-muted mb-2"><i class="bi bi-calendar"></i> ${fechaTexto}</h6>`;
    
    tomasPorFecha[fecha].forEach(toma => {
      const claseLado = `toma-${toma.lado.toLowerCase()}`;
      const iconoLado = {
        'izquierdo': 'üëà',
        'derecho': 'üëâ',
        'ambos': 'ü§≤'
      }[toma.lado.toLowerCase()] || 'ü§±';
      
      const estrellasHTML = toma.estrellas ? 
        `<span class="badge bg-warning text-dark ms-2"><i class="bi bi-star-fill"></i> ${toma.estrellas}</span>` : '';
      
      const duracion = calcularDuracion(toma.hora_inicio, toma.hora_fin);
      const horaFin = toma.hora_fin || '<em class="text-muted">En curso...</em>';
      
      html += `
        <div class="list-group-item ${claseLado}">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
              <div class="d-flex align-items-center mb-1">
                <span class="chip me-2">${iconoLado}</span>
                <strong>${toma.hora_inicio}</strong>
                ${toma.hora_fin ? `<span class="mx-1">‚Üí</span><strong>${toma.hora_fin}</strong>` : ''}
                ${duracion ? `<span class="badge bg-info ms-2">${duracion}</span>` : ''}
                ${estrellasHTML}
              </div>
              ${toma.comentarios ? `
                <div class="mt-1 text-muted">
                  <small><i class="bi bi-chat-left"></i> ${toma.comentarios}</small>
                </div>
              ` : ''}
              <div class="mt-1">
                <small class="text-muted">
                  <i class="bi bi-clock-history"></i> ${new Date(toma.updated_at || toma.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </small>
              </div>
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editarToma(${toma.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="eliminarToma(${toma.id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  lista.innerHTML = html;
}

function actualizarResumen() {
  const hoy = new Date().toISOString().split('T')[0];
  const tomasHoy = tomas.filter(t => t.fecha === hoy);
  
  let totalMinutos = 0;
  tomasHoy.forEach(t => {
    if (t.hora_inicio && t.hora_fin) {
      const minutos = calcularMinutos(t.hora_inicio, t.hora_fin);
      if (minutos > 0) totalMinutos += minutos;
    }
  });
  
  let ultimaToma = '--:--';
  if (tomasHoy.length > 0) {
    const ultima = tomasHoy.reduce((latest, toma) => {
      return toma.hora_inicio > latest.hora_inicio ? toma : latest;
    });
    ultimaToma = ultima.hora_inicio;
  }
  
  document.getElementById('totalTomas').textContent = tomasHoy.length;
  document.getElementById('tiempoTotal').textContent = 
    `${Math.floor(totalMinutos/60)}h ${totalMinutos%60}m`;
  document.getElementById('ultimaToma').textContent = ultimaToma;
}

function calcularMinutos(inicio, fin) {
  if (!inicio || !fin) return 0;
  try {
    const [h1, m1] = inicio.split(':').map(Number);
    const [h2, m2] = fin.split(':').map(Number);
    return (h2 * 60 + m2) - (h1 * 60 + m1);
  } catch (e) {
    return 0;
  }
}

function calcularDuracion(inicio, fin) {
  if (!inicio || !fin) return '';
  const minutos = calcularMinutos(inicio, fin);
  if (minutos <= 0) return '';
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  return horas > 0 ? `${horas}h ${mins}m` : `${mins}m`;
}

function mostrarNotificacion(mensaje) {
  const toast = document.createElement('div');
  toast.className = 'position-fixed bottom-0 end-0 p-3';
  toast.innerHTML = `
    <div class="toast show" role="alert">
      <div class="toast-header bg-success text-white">
        <strong class="me-auto">‚úÖ ${mensaje}</strong>
        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Exponer funciones
window.login = login;
window.logout = logout;
window.nuevaToma = nuevaToma;
window.cancelarToma = cancelarToma;
window.cerrarAhora = cerrarAhora;
window.setStars = setStars;
window.guardarToma = guardarToma;
window.editarToma = editarToma;
window.eliminarToma = eliminarToma;
window.mostrarConfig = mostrarConfig;
window.guardarConfig = guardarConfig;
</script>
</body>
</html>
