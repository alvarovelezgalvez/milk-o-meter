<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>milk-o-meter üçº</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{
      --baby-pink:#ffd6e7;
      --baby-blue:#dff3ff;
      --baby-mint:#e9fff5;
      --baby-purple:#efe7ff;
      --ink:#4a5568;
    }
    body{background:linear-gradient(180deg,var(--baby-blue),var(--baby-mint)); color:var(--ink); min-height:100vh}
    .card{border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); border:none}
    .btn-primary{background:#ff8fb3;border-color:#ff8fb3}
    .btn-primary:hover{background:#ff7aa5;border-color:#ff7aa5}
    .btn-success{background:#6bd1b3;border-color:#6bd1b3}
    .chip{background:var(--baby-purple); border-radius:999px; padding:.25rem .6rem; display:inline-block; font-size:0.85em}
    .stars span{cursor:pointer; user-select:none; font-size:1.8rem}
    .list-group-item{border-radius:1rem; margin-bottom:.5rem; border:none; background:rgba(255,255,255,0.9)}
    .star-filled{color:#ffc107}
    .star-empty{color:#ddd}
    .badge-estrella{background:#ffc107; color:#000}
    .toma-izquierda{border-left:4px solid #ff8fb3}
    .toma-derecha{border-left:4px solid #6bd1b3}
    .toma-ambos{border-left:4px solid #9d7aff}
    .connection-badge{font-size:0.75em}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="container py-4" id="loginView">
  <div class="card p-4 mx-auto" style="max-width:400px">
    <div class="text-center mb-3">
      <h1 class="display-1">üçº</h1>
      <h3 class="mb-2">milk-o-meter</h3>
      <p class="text-muted">Seguimiento de tomas üíï</p>
    </div>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a" autocomplete="off" />
    <button class="btn btn-primary w-100" onclick="login()">
      <i class="bi bi-door-open"></i> Entrar
    </button>
    <div class="mt-3 text-center">
      <small class="text-muted">Contrase√±a: ari</small>
    </div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="modal fade" id="configModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear"></i> Configuraci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Configura estos datos una sola vez para sincronizar entre dispositivos</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Tu usuario de GitHub</label>
          <input type="text" id="githubUser" class="form-control" placeholder="ej: tuusuario" />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Nombre del repositorio</label>
          <input type="text" id="repoName" class="form-control" placeholder="ej: milk-o-meter" value="milk-o-meter" />
        </div>
        
        <div class="mb-3">
          <label class="form-label">Token de GitHub</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
          <small class="text-muted">
            <a href="https://github.com/settings/tokens" target="_blank">Crear token aqu√≠</a> (permisos: repo)
          </small>
        </div>
        
        <div class="alert alert-warning">
          <small><i class="bi bi-exclamation-triangle"></i> <strong>Instrucciones:</strong>
          <ol class="mb-0">
            <li>Crea repositorio en GitHub (p√∫blico o privado)</li>
            <li>Crea token en GitHub con permisos "repo"</li>
            <li>Introduce los datos aqu√≠</li>
            <li>¬°Listo! Los datos se sincronizar√°n autom√°ticamente</li>
          </ol>
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarConfig()">
          <i class="bi bi-save"></i> Guardar configuraci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="container py-3 d-none" id="appView">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">milk-o-meter üçº</h3>
      <div class="connection-badge">
        <span class="badge" id="syncStatus">‚óè Desconectado</span>
        <small class="text-muted ms-2" id="lastSync">--:--</small>
      </div>
    </div>
    <div>
      <button class="btn btn-outline-info btn-sm me-2" onclick="mostrarConfig()">
        <i class="bi bi-gear"></i>
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Resumen -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-graph-up"></i> Resumen de hoy
      </h6>
      <div class="row text-center">
        <div class="col">
          <div class="display-6" id="totalTomas">0</div>
          <small class="text-muted">Tomas</small>
        </div>
        <div class="col">
          <div class="display-6" id="tiempoTotal">0h 0m</div>
          <small class="text-muted">Tiempo</small>
        </div>
        <div class="col">
          <div class="display-6" id="ultimaToma">--:--</div>
          <small class="text-muted">√öltima</small>
        </div>
      </div>
      <div class="mt-2 text-center">
        <small class="text-muted" id="totalRegistros">Cargando...</small>
      </div>
    </div>
  </div>

  <!-- Bot√≥n Nueva Toma -->
  <button class="btn btn-success w-100 mb-3 py-3" onclick="nuevaToma()">
    <i class="bi bi-plus-circle"></i> Nueva Toma
  </button>

  <!-- Formulario Toma -->
  <div id="formToma" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title mb-3" id="formTitle">
        <i class="bi bi-clock-history"></i> Nueva Toma
      </h5>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-play-circle"></i> Hora inicio</label>
        <input type="time" id="inicio" class="form-control form-control-lg" required />
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-stop-circle"></i> Hora fin</label>
        <div class="input-group">
          <input type="time" id="fin" class="form-control" />
          <button class="btn btn-outline-secondary" type="button" onclick="cerrarAhora()">
            <i class="bi bi-clock"></i> Ahora
          </button>
        </div>
        <small class="text-muted">Dejar vac√≠o si a√∫n est√° tomando</small>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-star"></i> Cantidad</label>
        <div id="estrellas" class="stars text-center">
          <span onclick="setStars(1)">‚òÜ</span>
          <span onclick="setStars(2)">‚òÜ</span>
          <span onclick="setStars(3)">‚òÜ</span>
          <span onclick="setStars(4)">‚òÜ</span>
          <span onclick="setStars(5)">‚òÜ</span>
        </div>
        <div class="text-center mt-1">
          <span id="estrellasTexto" class="badge badge-estrella">0 estrellas</span>
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-symmetry-vertical"></i> Pecho</label>
        <select id="lado" class="form-select">
          <option value="Izquierdo">üëà Izquierdo</option>
          <option value="Derecho">üëâ Derecho</option>
          <option value="Ambos">ü§≤ Ambos</option>
        </select>
      </div>
      
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-chat-text"></i> Comentarios</label>
        <textarea id="comentarios" class="form-control" rows="2" placeholder="Notas, observaciones..."></textarea>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="guardarToma()" id="btnGuardar">
          <i class="bi bi-save"></i> Guardar Toma
        </button>
        <button class="btn btn-outline-danger" onclick="cancelarToma()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div class="card">
    <div class="card-body">
      <h6 class="card-title mb-3">
        <i class="bi bi-list-check"></i> Historial de Tomas
      </h6>
      <div id="lista" class="list-group list-group-flush">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Cargando tomas...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/************ CONFIGURACI√ìN ************/
const APP_PASSWORD = 'ari';
const CONFIG_KEY = 'milkometer_config_v1';
const DATA_KEY = 'milkometer_local_data_v1';

let tomas = [];
let editId = null;
let estrellasValor = 3;
let config = null;
let syncInterval = null;

/************ INICIALIZACI√ìN ************/
document.addEventListener('DOMContentLoaded', function() {
  const passwordField = document.getElementById('password');
  if (passwordField) {
    passwordField.focus();
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  }
  
  if (localStorage.getItem('milkometer_auth') === 'true') {
    initApp();
  }
});

/************ AUTENTICACI√ìN ************/
function login() {
  const password = document.getElementById('password').value;
  if (password === APP_PASSWORD) {
    localStorage.setItem('milkometer_auth', 'true');
    initApp();
  } else {
    alert('Contrase√±a incorrecta');
    document.getElementById('password').focus();
    document.getElementById('password').select();
  }
}

function logout() {
  if (confirm('¬øSeguro que quieres salir?')) {
    localStorage.removeItem('milkometer_auth');
    if (syncInterval) clearInterval(syncInterval);
    location.reload();
  }
}

/************ INICIALIZACI√ìN APP ************/
function initApp() {
  document.getElementById('loginView').classList.add('d-none');
  document.getElementById('appView').classList.remove('d-none');
  cargarConfig();
  cargarDatos();
  syncInterval = setInterval(sincronizarConGitHub, 30000);
}

/************ CONFIG GITHUB ************/
function cargarConfig() {
  const configGuardada = localStorage.getItem(CONFIG_KEY);
  if (configGuardada) {
    try {
      config = JSON.parse(configGuardada);
    } catch (e) {
      console.error('Error cargando configuraci√≥n:', e);
      config = null;
    }
  }
  if (!config || !config.githubUser || !config.githubToken) setTimeout(mostrarConfig, 500);
}

function guardarConfig() {
  const githubUser = document.getElementById('githubUser').value.trim();
  const repoName = document.getElementById('repoName').value.trim() || 'milk-o-meter';
  const githubToken = document.getElementById('githubToken').value.trim();
  
  if (!githubUser || !githubToken) { alert('Por favor, completa todos los campos'); return; }
  
  config = { githubUser, repoName, githubToken, configuredAt: new Date().toISOString() };
  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
  if (modal) modal.hide();
  alert('‚úÖ Configuraci√≥n guardada. Ahora se sincronizar√° con GitHub.');
  sincronizarConGitHub();
}

function mostrarConfig() {
  const modal = new bootstrap.Modal(document.getElementById('configModal'));
  if (config) {
    document.getElementById('githubUser').value = config.githubUser || '';
    document.getElementById('repoName').value = config.repoName || 'milk-o-meter';
    document.getElementById('githubToken').value = config.githubToken || '';
  }
  modal.show();
}

/************ GESTI√ìN DE DATOS ************/
function cargarDatos() {
  const datosLocales = localStorage.getItem(DATA_KEY);
  if (datosLocales) {
    try { tomas = JSON.parse(datosLocales); } catch(e){ tomas=[]; }
  }
  renderizarTomas(); actualizarResumen(); actualizarInfo();
}

function guardarDatosLocales() {
  localStorage.setItem(DATA_KEY, JSON.stringify(tomas));
}

async function guardarDatos() {
  guardarDatosLocales();
  if (config && config.githubUser && config.githubToken) {
    try { await guardarDatosEnGitHub(); actualizarSyncStatus('success', 'Guardado en GitHub'); }
    catch(e){ actualizarSyncStatus('warning','Guardado localmente'); }
  } else actualizarSyncStatus('warning','Guardado localmente');
}

/************ INTERFAZ ************/
function actualizarSyncStatus(status,texto){
  const statusElement = document.getElementById('syncStatus');
  const badgeClass = {'success':'bg-success','warning':'bg-warning','danger':'bg-danger'}[status] || 'bg-secondary';
  statusElement.className = `badge ${badgeClass}`; statusElement.textContent = `‚óè ${texto}`;
  const ahora = new Date();
  document.getElementById('lastSync').textContent = `${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;
}

function actualizarInfo(){
  const hoy = new Date().toISOString().split('T')[0];
  const tomasHoy = tomas.filter(t => t.fecha === hoy).length;
  const totalTomas = tomas.length;
  document.getElementById('totalRegistros').textContent = `${tomasHoy} tomas hoy | ${totalTomas} en total`;
}

function nuevaToma() {
  editId=null;
  document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML = '<i class="bi bi-clock-history"></i> Nueva Toma';
  const ahora=new Date();
  const hora=String(ahora.getHours()).padStart(2,'0');
  const minutos=String(ahora.getMinutes()).padStart(2,'0');
  document.getElementById('inicio').value=`${hora}:${minutos}`;
  document.getElementById('fin').value=''; document.getElementById('comentarios').value='';
  setStars(3); document.getElementById('lado').value='Izquierdo';
  document.getElementById('btnGuardar').innerHTML='<i class="bi bi-save"></i> Guardar Toma';
  document.getElementById('formToma').scrollIntoView({behavior:'smooth'});
}

function cancelarToma(){document.getElementById('formToma').classList.add('d-none');}
function cerrarAhora(){const ahora=new Date();document.getElementById('fin').value=`${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;}

function setStars(n){
  estrellasValor=n;
  const stars=document.querySelectorAll('#estrellas span');
  stars.forEach((s,i)=>{s.textContent=i<n?'‚òÖ':'‚òÜ';});
  document.getElementById('estrellasTexto').textContent=`${n} estrellas`;
}

function guardarToma(){
  const fecha=new Date().toISOString().split('T')[0];
  const inicio=document.getElementById('inicio').value;
  const fin=document.getElementById('fin').value || null;
  const lado=document.getElementById('lado').value;
  const comentarios=document.getElementById('comentarios').value;

  const ahora=new Date();
  const nuevaToma={
    id:editId || Date.now(),
    fecha,
    hora_inicio:inicio,
    hora_fin:fin,
    estrellas:estrellasValor,
    lado,
    comentarios:comentarios || '',
    created_at:editId ? tomas.find(t=>t.id===editId).created_at : ahora.toISOString(),
    updated_at: ahora.toISOString()
  };

  if(editId){
    tomas=tomas.map(t=>t.id===editId?nuevaToma:t);
  } else tomas.unshift(nuevaToma);

  guardarDatos();
  renderizarTomas();
  actualizarResumen();
  actualizarInfo();
  cancelarToma();
}

function renderizarTomas(){
  const lista=document.getElementById('lista'); lista.innerHTML='';
  if(tomas.length===0){
    lista.innerHTML='<div class="text-center py-4 text-muted">Sin tomas registradas</div>'; return;
  }
  tomas.forEach(t=>{
    const item=document.createElement('div');
    item.className='list-group-item '+(t.lado==='Izquierdo'?'toma-izquierda':t.lado==='Derecho'?'toma-derecha':'toma-ambos');
    item.innerHTML=`
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>${t.hora_inicio}</strong>${t.hora_fin?` - <strong>${t.hora_fin}</strong>`:''} (${t.lado})
          <div class="stars">${'‚òÖ'.repeat(t.estrellas)+'‚òÜ'.repeat(5-t.estrellas)}</div>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary me-1" onclick="editarToma(${t.id})"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="borrarToma(${t.id})"><i class="bi bi-trash"></i></button>
        </div>
      </div>
      ${t.comentarios?`<div class="mt-1 text-muted"><small>${t.comentarios}</small></div>`:''}
    `;
    lista.appendChild(item);
  });
}

function editarToma(id){
  const t=tomas.find(x=>x.id===id); if(!t)return;
  editId=id; document.getElementById('formToma').classList.remove('d-none');
  document.getElementById('formTitle').innerHTML='<i class="bi bi-pencil"></i> Editar Toma';
  document.getElementById('inicio').value=t.hora_inicio;
  document.getElementById('fin').value=t.hora_fin||'';
  document.getElementById('comentarios').value=t.comentarios||'';
  document.getElementById('lado').value=t.lado;
  setStars(t.estrellas);
  document.getElementById('btnGuardar').innerHTML='<i class="bi bi-save"></i> Actualizar Toma';
  document.getElementById('formToma').scrollIntoView({behavior:'smooth'});
}

function borrarToma(id){
  if(!confirm('¬øEliminar esta toma?')) return;
  tomas=tomas.filter(t=>t.id!==id); guardarDatos(); renderizarTomas(); actualizarResumen(); actualizarInfo();
}

function calcularMinutos(inicio,fin){
  if(!inicio||!fin)return 0;
  const [h1,m1]=inicio.split(':').map(Number); const [h2,m2]=fin.split(':').map(Number);
  return (h2*60+m2)-(h1*60+m1);
}

function actualizarResumen(){
  const hoy=new Date().toISOString().split('T')[0];
  const tomasHoy=tomas.filter(t=>t.fecha===hoy);
  let totalMin=0;
  tomasHoy.forEach(t=>{if(t.hora_inicio&&t.hora_fin) totalMin+=calcularMinutos(t.hora_inicio,t.hora_fin);});
  const horas=Math.floor(totalMin/60); const minutos=totalMin%60;
  const ultima=tomasHoy.length>0?tomasHoy[0].hora_fin||tomasHoy[0].hora_inicio:'--:--';
  document.getElementById('totalTomas').textContent=tomasHoy.length;
  document.getElementById('tiempoTotal').textContent=`${horas}h ${minutos}m`;
  document.getElementById('ultimaToma').textContent=ultima;
}

/************ SINCRONIZACI√ìN GITHUB ************/
function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(_,p1)=>String.fromCharCode('0x'+p1))); }
function b64DecodeUnicode(str){return decodeURIComponent(atob(str).split('').map(c=>'%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join(''));}

async function guardarDatosEnGitHub(){
  const url=`https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/milkometer.json`;
  const contenido=b64EncodeUnicode(JSON.stringify(tomas,null,2));

  let sha=null;
  try{
    const r=await fetch(url,{headers:{Authorization:`token ${config.githubToken}`}});
    if(r.ok){ const data=await r.json(); sha=data.sha; }
  }catch(e){ /* si no existe, se crea */ }

  const body={message:'Actualizar datos milk-o-meter', content:contenido};
  if(sha) body.sha=sha;

  const res=await fetch(url,{
    method:'PUT',
    headers:{Authorization:`token ${config.githubToken}`,'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  if(!res.ok) throw new Error('Error subiendo a GitHub');
}

async function sincronizarConGitHub(){
  if(!config || !config.githubUser || !config.githubToken) return;
  try{
    const url=`https://api.github.com/repos/${config.githubUser}/${config.repoName}/contents/milkometer.json`;
    const res=await fetch(url,{headers:{Authorization:`token ${config.githubToken}`}});
    if(res.ok){
      const data=await res.json();
      const remoto=b64DecodeUnicode(data.content);
      tomas=JSON.parse(remoto); guardarDatosLocales(); renderizarTomas(); actualizarResumen(); actualizarInfo();
      actualizarSyncStatus('success','Sincronizado con GitHub');
    }
  }catch(e){ actualizarSyncStatus('danger','Error sincronizando'); }
}
</script>
</body>
</html>
