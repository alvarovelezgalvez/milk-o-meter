<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>milk-o-meter üçº</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.1/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --baby-pink:#ffd6e7;
      --baby-blue:#dff3ff;
      --baby-mint:#e9fff5;
      --baby-purple:#efe7ff;
      --ink:#4a5568;
    }
    body{background:linear-gradient(180deg,var(--baby-blue),var(--baby-mint)); color:var(--ink); min-height:100vh}
    .card{border-radius:1.25rem; box-shadow:0 10px 25px rgba(0,0,0,.06); border:none}
    .btn-primary{background:#ff8fb3;border-color:#ff8fb3}
    .btn-primary:hover{background:#ff7aa5;border-color:#ff7aa5}
    .btn-success{background:#6bd1b3;border-color:#6bd1b3}
    .chip{background:var(--baby-purple); border-radius:999px; padding:.25rem .6rem; display:inline-block}
    .stars span{cursor:pointer; user-select:none; font-size:2rem}
    .list-group-item{border-radius:1rem; margin-bottom:.5rem; border:none; background:rgba(255,255,255,0.8)}
    #loading{display:none}
    .star-filled{color:#ffc107}
    .star-empty{color:#ddd}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="container py-4" id="loginView">
  <div class="card p-4">
    <h3 class="mb-2 text-center">milk-o-meter üçº - Ariadna üíï</h3>
    <input type="password" id="password" class="form-control mb-3" placeholder="Contrase√±a" autocomplete="off" />
    <button class="btn btn-primary w-100" onclick="login()">Entrar üë∂</button>
  </div>
</div>

<!-- APP -->
<div class="container py-4 d-none" id="appView">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>milk-o-meter üçº</h3>
    <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Salir</button>
  </div>

  <div class="mb-3">
    <button class="btn btn-success w-100 mb-2" onclick="nuevaToma()">+ Nueva toma ü§±</button>
    <div class="alert alert-info d-none" id="loading">
      <div class="spinner-border spinner-border-sm me-2" role="status"></div>
      Cargando...
    </div>
    <div class="card">
      <div class="card-body" id="resumen">Cargando resumen...</div>
    </div>
  </div>

  <div id="formToma" class="card mb-3 d-none">
    <div class="card-body">
      <div class="mb-2">
        <label>Hora inicio ‚è±Ô∏è</label>
        <input type="time" id="inicio" class="form-control" required />
      </div>
      <div class="mb-2">
        <label>Hora fin ‚è∞</label>
        <input type="time" id="fin" class="form-control" />
      </div>
      <div class="mb-2">
        <label>Cantidad ‚≠ê</label>
        <div id="estrellas" class="stars">
          <span onclick="setStars(1)">‚òÜ</span>
          <span onclick="setStars(2)">‚òÜ</span>
          <span onclick="setStars(3)">‚òÜ</span>
          <span onclick="setStars(4)">‚òÜ</span>
          <span onclick="setStars(5)">‚òÜ</span>
        </div>
        <small class="text-muted">Click en las estrellas para valorar</small>
      </div>
      <div class="mb-2">
        <label>Pecho ü´∂</label>
        <select id="lado" class="form-select">
          <option>Izquierdo</option>
          <option>Derecho</option>
          <option>Ambos</option>
        </select>
      </div>
      <div class="mb-2">
        <label>Comentarios üí¨</label>
        <textarea id="comentarios" class="form-control" rows="2"></textarea>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary" onclick="guardarToma()" id="btnGuardar">Guardar üíæ</button>
        <button class="btn btn-outline-secondary" onclick="cerrarAhora()">Cerrar toma ahora ‚è±Ô∏è</button>
        <button class="btn btn-outline-danger" onclick="cancelarToma()">Cancelar</button>
      </div>
    </div>
  </div>

  <h5 class="mt-4 mb-3">Historial de tomas üìã</h5>
  <ul class="list-group" id="lista">
    <li class="list-group-item text-center">Cargando...</li>
  </ul>
</div>

<script>
/************ CONFIG ************/
const APP_PASSWORD = 'ari';
const SUPABASE_URL = 'https://kkrwueybekmyciktmjit.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtrcnd1ZXliZWtteWNpa3Rtaml0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5Mjg0MDIsImV4cCI6MjA1ODUwNDQwMn0.qMqex-e7_PuY4dGElNZ85ptV0fFbff4nmj-08FxtYpY';

// Inicializar Supabase
let supabase;
try {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('Supabase inicializado correctamente');
} catch (error) {
  console.error('Error inicializando Supabase:', error);
  alert('Error inicializando la base de datos. Recarga la p√°gina.');
}

let editId = null;
let estrellasValor = 0;

/************ UTILIDADES ************/
function showLoading(show) {
  document.getElementById('loading').classList.toggle('d-none', !show);
}

function getElement(id) {
  return document.getElementById(id);
}

/************ LOGIN ************/
function login() {
  const password = getElement('password');
  if (password.value === APP_PASSWORD) {
    localStorage.setItem('auth', '1');
    init();
  } else {
    alert('Ups, contrase√±a incorrecta');
    password.focus();
    password.select();
  }
}

function logout() {
  if (confirm('¬øSeguro que quieres salir?')) {
    localStorage.removeItem('auth');
    location.reload();
  }
}

function init() {
  getElement('loginView').classList.add('d-none');
  getElement('appView').classList.remove('d-none');
  cargarTomas();
}

/************ TOMAS ************/
function nuevaToma() {
  editId = null;
  getElement('formToma').classList.remove('d-none');
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  getElement('inicio').value = `${h}:${m}`;
  getElement('fin').value = '';
  getElement('comentarios').value = '';
  estrellasValor = 0;
  setStars(0);
  getElement('lado').value = 'Izquierdo';
  getElement('btnGuardar').textContent = 'Guardar üíæ';
  getElement('btnGuardar').disabled = false;
}

function cancelarToma() {
  getElement('formToma').classList.add('d-none');
}

function cerrarAhora() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  getElement('fin').value = `${h}:${m}`;
}

function setStars(n) {
  estrellasValor = n;
  const stars = document.querySelectorAll('#estrellas span');
  stars.forEach((star, index) => {
    if (index < n) {
      star.textContent = '‚òÖ';
      star.className = 'star-filled';
    } else {
      star.textContent = '‚òÜ';
      star.className = 'star-empty';
    }
  });
}

async function guardarToma() {
  const inicio = getElement('inicio').value;
  const fin = getElement('fin').value;
  const lado = getElement('lado').value;
  const comentarios = getElement('comentarios').value;
  
  if (!inicio) {
    alert('Por favor, ingresa la hora de inicio');
    return;
  }
  
  const data = {
    fecha: new Date().toISOString().split('T')[0],
    hora_inicio: inicio,
    hora_fin: fin || null,
    estrellas: estrellasValor,
    lado: lado,
    comentarios: comentarios || null,
    created_at: new Date().toISOString()
  };
  
  const btn = getElement('btnGuardar');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
  
  try {
    if (!supabase) {
      throw new Error('No se pudo conectar a la base de datos');
    }
    
    let result;
    if (editId) {
      result = await supabase
        .from('mkm_toma')
        .update(data)
        .eq('id', editId);
    } else {
      result = await supabase
        .from('mkm_toma')
        .insert([data]);
    }
    
    if (result.error) {
      throw result.error;
    }
    
    getElement('formToma').classList.add('d-none');
    await cargarTomas();
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function cargarTomas() {
  showLoading(true);
  
  try {
    if (!supabase) {
      throw new Error('No se pudo conectar a la base de datos');
    }
    
    const { data, error } = await supabase
      .from('mkm_toma')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) {
      throw error;
    }
    
    const lista = getElement('lista');
    const resumen = getElement('resumen');
    
    // Mostrar historial
    lista.innerHTML = '';
    
    if (!data || data.length === 0) {
      lista.innerHTML = '<li class="list-group-item text-center">No hay tomas registradas todav√≠a</li>';
      resumen.innerHTML = '<strong>Resumen de hoy üë∂</strong><br>ü§± Tomas: 0<br>‚è±Ô∏è Tiempo total: 0h 0min';
      return;
    }
    
    data.forEach(t => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      
      // Formatear fecha
      const fecha = t.fecha || 'Sin fecha';
      const horaInicio = t.hora_inicio || '--:--';
      const horaFin = t.hora_fin || 'En curso...';
      const estrellas = t.estrellas ? '‚òÖ'.repeat(t.estrellas) + '‚òÜ'.repeat(5 - t.estrellas) : '';
      
      li.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div style="flex: 1;">
            <strong>${fecha}</strong><br>
            <small>${horaInicio} - ${horaFin}</small><br>
            <span class="chip me-2">${t.lado || 'No especificado'}</span>
            ${estrellas ? `<span class="text-warning">${estrellas}</span>` : ''}
            ${t.comentarios ? '<div class="mt-2"><small>üí¨ ' + t.comentarios + '</small></div>' : ''}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="editarToma(${t.id})">
              Editar
            </button>
          </div>
        </div>
      `;
      
      // Asignar datos al elemento para acceso f√°cil
      li.dataset.tomaId = t.id;
      lista.appendChild(li);
    });
    
    // Calcular resumen del d√≠a
    const hoy = new Date().toISOString().split('T')[0];
    const tomasHoy = data.filter(t => t.fecha === hoy);
    let totalMinutos = 0;
    
    tomasHoy.forEach(t => {
      if (t.hora_inicio && t.hora_fin) {
        try {
          const [h1, m1] = t.hora_inicio.split(':').map(Number);
          const [h2, m2] = t.hora_fin.split(':').map(Number);
          const minutos = (h2 * 60 + m2) - (h1 * 60 + m1);
          if (minutos > 0) {
            totalMinutos += minutos;
          }
        } catch (e) {
          console.warn('Error calculando tiempo para toma:', t.id, e);
        }
      }
    });
    
    const horas = Math.floor(totalMinutos / 60);
    const minutos = totalMinutos % 60;
    
    resumen.innerHTML = `
      <strong>Resumen de hoy üë∂</strong><br>
      ü§± Tomas: ${tomasHoy.length}<br>
      ‚è±Ô∏è Tiempo total: ${horas}h ${minutos}min<br>
      <small class="text-muted">√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}</small>
    `;
    
  } catch (error) {
    console.error('Error cargando tomas:', error);
    getElement('lista').innerHTML = '<li class="list-group-item text-center text-danger">Error al cargar las tomas. Recarga la p√°gina.</li>';
    getElement('resumen').innerHTML = '<div class="alert alert-danger">‚ö†Ô∏è Error conectando con la base de datos. Verifica tu conexi√≥n.</div>';
  } finally {
    showLoading(false);
  }
}

async function editarToma(id) {
  try {
    const { data, error } = await supabase
      .from('mkm_toma')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    if (!data) {
      alert('No se encontr√≥ la toma');
      return;
    }
    
    editId = id;
    getElement('formToma').classList.remove('d-none');
    getElement('inicio').value = data.hora_inicio || '';
    getElement('fin').value = data.hora_fin || '';
    setStars(data.estrellas || 0);
    getElement('lado').value = data.lado || 'Izquierdo';
    getElement('comentarios').value = data.comentarios || '';
    getElement('btnGuardar').textContent = 'Actualizar ‚úì';
    
    // Scroll al formulario
    getElement('formToma').scrollIntoView({ behavior: 'smooth' });
    
  } catch (error) {
    console.error('Error cargando toma para editar:', error);
    alert('Error al cargar la toma para editar: ' + error.message);
  }
}

/************ INICIALIZACI√ìN ************/
document.addEventListener('DOMContentLoaded', function() {
  // Auto-focus en el campo de contrase√±a
  const passwordField = getElement('password');
  if (passwordField) {
    passwordField.focus();
    
    // Permitir Enter para login
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        login();
      }
    });
  }
  
  // Verificar autenticaci√≥n
  if (localStorage.getItem('auth')) {
    init();
  }
  
  // Exponer funciones al √°mbito global
  window.login = login;
  window.logout = logout;
  window.nuevaToma = nuevaToma;
  window.cancelarToma = cancelarToma;
  window.cerrarAhora = cerrarAhora;
  window.setStars = setStars;
  window.guardarToma = guardarToma;
  window.editarToma = editarToma;
});
</script>
</body>
</html>
